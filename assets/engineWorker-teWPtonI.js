var he={},V={},S={},ve={},ge;function le(){return ge||(ge=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ROOKS=e.SQUARES=e.RANKS=e.RANK_8=e.RANK_7=e.RANK_6=e.RANK_5=e.RANK_4=e.RANK_3=e.RANK_2=e.RANK_1=e.BITS=e.FLAGS=e.SHIFTS=e.RAYS=e.ATTACKS=e.PIECE_OFFSETS=e.PAWN_OFFSETS=e.POSSIBLE_RESULTS=e.DEFAULT_POSITION=e.SYMBOLS=e.EMPTY=e.KING=e.QUEEN=e.ROOK=e.BISHOP=e.KNIGHT=e.PAWN=e.BLACK=e.WHITE=void 0,e.WHITE="w",e.BLACK="b",e.PAWN="p",e.KNIGHT="n",e.BISHOP="b",e.ROOK="r",e.QUEEN="q",e.KING="k",e.EMPTY=-1,e.SYMBOLS="pnbrqkPNBRQK",e.DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",e.POSSIBLE_RESULTS=["1-0","0-1","1/2-1/2","*"],e.PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},e.PIECE_OFFSETS={p:[],n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},e.ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],e.RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],e.SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5},e.FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},e.BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},e.RANK_1=7,e.RANK_2=6,e.RANK_3=5,e.RANK_4=4,e.RANK_5=3,e.RANK_6=2,e.RANK_7=1,e.RANK_8=0,e.RANKS=[e.RANK_8,e.RANK_7,e.RANK_6,e.RANK_5,e.RANK_4,e.RANK_3,e.RANK_2,e.RANK_1],e.SQUARES={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},e.ROOKS={w:[{square:e.SQUARES.a1,flag:e.BITS.QSIDE_CASTLE},{square:e.SQUARES.h1,flag:e.BITS.KSIDE_CASTLE}],b:[{square:e.SQUARES.a8,flag:e.BITS.QSIDE_CASTLE},{square:e.SQUARES.h8,flag:e.BITS.KSIDE_CASTLE}]}})(ve)),ve}var se={},_e;function de(){if(_e)return se;_e=1,Object.defineProperty(se,"__esModule",{value:!0}),se.State=void 0;var e=le(),o=Te(),r=(function(){function v(h,b,T,f,t,l,m){this.board=h||new Array(128),this.kings=b||{w:e.EMPTY,b:e.EMPTY},this.turn=T||e.WHITE,this.castling=f||{w:0,b:0},this.ep_square=t||e.EMPTY,this.half_moves=l||0,this.move_number=m||1}return v.prototype.clone=function(){return new v(this.board.slice(),{w:this.kings.w,b:this.kings.b},this.turn,{w:this.castling.w,b:this.castling.b},this.ep_square,this.half_moves,this.move_number)},Object.defineProperty(v.prototype,"fen",{get:function(){return o.getFen(this)},enumerable:!1,configurable:!0}),v})();return se.State=r,se}var k={},Se;function me(){if(Se)return k;Se=1,Object.defineProperty(k,"__esModule",{value:!0}),k.strippedSan=k.validateFen=k.isFlagKey=k.isSquare=k.isPieceSymbol=k.isColor=k.symbol=k.isDigit=k.swapColor=k.algebraic=k.file=k.rank=void 0;var e=le();function o(p){return p>>4}k.rank=o;function r(p){return p&15}k.file=r;function v(p){var y=r(p),N=o(p);return"abcdefgh".substring(y,y+1)+"87654321".substring(N,N+1)}k.algebraic=v;function h(p){return p===e.WHITE?e.BLACK:e.WHITE}k.swapColor=h;function b(p){return/^[0-9]$/.test(p)}k.isDigit=b;function T(p){var y=p.type,N=p.color;return N===e.WHITE?y.toUpperCase():y.toLowerCase()}k.symbol=T;function f(p){return p==="w"||p==="b"}k.isColor=f;function t(p){return/^[pnbrqk]$/.test(p)}k.isPieceSymbol=t;function l(p){return/^[a-h][1-8]$/.test(p)}k.isSquare=l;function m(p){var y=["NORMAL","CAPTURE","BIG_PAWN","EP_CAPTURE","PROMOTION","KSIDE_CASTLE","QSIDE_CASTLE"];return y.indexOf(p)!==-1}k.isFlagKey=m;function A(p){var y={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},N=p.split(/\s+/);if(N.length!==6)return{valid:!1,error_number:1,error:y[1]};if(isNaN(N[5])||parseInt(N[5],10)<=0)return{valid:!1,error_number:2,error:y[2]};if(isNaN(N[4])||parseInt(N[4],10)<0)return{valid:!1,error_number:3,error:y[3]};if(!/^(-|[abcdefgh][36])$/.test(N[3]))return{valid:!1,error_number:4,error:y[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(N[2]))return{valid:!1,error_number:5,error:y[5]};if(!/^(w|b)$/.test(N[1]))return{valid:!1,error_number:6,error:y[6]};var j=N[0].split("/");if(j.length!==8)return{valid:!1,error_number:7,error:y[7]};for(var Q=0;Q<j.length;Q++){for(var x=0,Z=!1,J=0;J<j[Q].length;J++)if(isNaN(j[Q][J])){if(!/^[prnbqkPRNBQK]$/.test(j[Q][J]))return{valid:!1,error_number:9,error:y[9]};x+=1,Z=!1}else{if(Z)return{valid:!1,error_number:8,error:y[8]};x+=parseInt(j[Q][J],10),Z=!0}if(x!==8)return{valid:!1,error_number:10,error:y[10]}}return N[3][1]=="3"&&N[1]=="w"||N[3][1]=="6"&&N[1]=="b"?{valid:!1,error_number:11,error:y[11]}:{valid:!0,error_number:0,error:y[0]}}k.validateFen=A;function P(p){return p.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}return k.strippedSan=P,k}var be;function Te(){if(be)return S;be=1,Object.defineProperty(S,"__esModule",{value:!0}),S.validateMove=S.getBoard=S.ascii=S.buildMove=S.makeMove=S.insufficientMaterial=S.inStalemate=S.inCheckmate=S.inCheck=S.isKingAttacked=S.isAttacked=S.makePretty=S.sanToMove=S.moveToSan=S.generateMoves=S.removePiece=S.putPiece=S.clonePiece=S.cloneMove=S.getPiece=S.loadPgn=S.getPgn=S.loadFen=S.getFen=S.getDisambiguator=void 0;var e=le(),o=de(),r=me();function v(n,i,a){for(var s=p(n,{legal:!a}),u=i.from,g=i.to,d=i.piece,_=0,c=0,E=0,O=0,C=s.length;O<C;O++){var w=s[O].from,R=s[O].to,I=s[O].piece;d===I&&u!==w&&g===R&&(_++,r.rank(u)===r.rank(w)&&c++,r.file(u)===r.file(w)&&E++)}return _>0?c>0&&E>0?r.algebraic(u):E>0?r.algebraic(u).charAt(1):r.algebraic(u).charAt(0):""}S.getDisambiguator=v;function h(n){for(var i=0,a="",s=e.SQUARES.a8;s<=e.SQUARES.h1;s++){var u=n.board[s];if(!u)i++;else{i>0&&(a+=i,i=0);var g=u.color,d=u.type;a+=g===e.WHITE?d.toUpperCase():d.toLowerCase()}s+1&136&&(i>0&&(a+=i),s!==e.SQUARES.h1&&(a+="/"),i=0,s+=8)}var _="";n.castling[e.WHITE]&e.BITS.KSIDE_CASTLE&&(_+="K"),n.castling[e.WHITE]&e.BITS.QSIDE_CASTLE&&(_+="Q"),n.castling[e.BLACK]&e.BITS.KSIDE_CASTLE&&(_+="k"),n.castling[e.BLACK]&e.BITS.QSIDE_CASTLE&&(_+="q"),_=_||"-";var c=n.ep_square===e.EMPTY?"-":r.algebraic(n.ep_square);return[a,n.turn,_,c,n.half_moves,n.move_number].join(" ")}S.getFen=h;function b(n){var i=n.split(/\s+/),a=i[0],s=0;if(!r.validateFen(n).valid)return null;for(var u=new o.State,g=0;g<a.length;g++){var d=a.charAt(g);if(d==="/")s+=8;else if(r.isDigit(d))s+=parseInt(d,10);else{var _=d<"a"?e.WHITE:e.BLACK,c=A(u,{type:d.toLowerCase(),color:_},r.algebraic(s));if(!c)return null;u=c,s++}}return u.turn=i[1]===e.BLACK?e.BLACK:e.WHITE,i[2].indexOf("K")>-1&&(u.castling.w|=e.BITS.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(u.castling.w|=e.BITS.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(u.castling.b|=e.BITS.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(u.castling.b|=e.BITS.QSIDE_CASTLE),u.ep_square=i[3]==="-"?e.EMPTY:e.SQUARES[i[3]],u.half_moves=parseInt(i[4],10),u.move_number=parseInt(i[5],10),u}S.loadFen=b;function T(n,i,a,s,u){u===void 0&&(u={});var g=u.newline_char,d=g===void 0?`
`:g,_=u.max_width,c=_===void 0?0:_,E=[],O=!1;for(var C in i)E.push("["+C+' "'+i[C]+'"]'+d),O=!0;O&&s.length&&E.push(d);var w=function(L){var F=a[n.fen];if(typeof F<"u"){var U=L.length>0?" ":"";L=""+L+U+"{"+F+"}"}return L};s[0]&&(n=s[0].state);var R=[],I="";if(s.length===0&&R.push(w("")),s.forEach(function(L,F){var U=L.move;I=w(I),F===0&&U.color===e.BLACK?I=n.move_number+". ...":U.color===e.WHITE&&(I.length&&R.push(I),I=n.move_number+"."),I=I+" "+y(n,U),n=ne(n,U)}),I.length&&R.push(w(I)),typeof i.Result<"u"&&R.push(i.Result),c===0)return E.join("")+R.join(" ");for(var M=function(){return E.length>0&&E[E.length-1]===" "?(E.pop(),!0):!1},q=function(L,F){for(var U=0,Y=F.split(" ");U<Y.length;U++){var D=Y[U];if(D){if(L+D.length>c){for(;M();)L--;E.push(d),L=0}E.push(D),L+=D.length,E.push(" "),L++}}return M()&&L--,L},K=0,C=0;C<R.length;C++){if(K+R[C].length>c&&R[C].includes("{")){K=q(K,R[C]);continue}K+R[C].length>c&&C!==0?(E[E.length-1]===" "&&E.pop(),E.push(d),K=0):C!==0&&(E.push(" "),K++),E.push(R[C]),K+=R[C].length}return E.join("")}S.getPgn=T;function f(n,i){i===void 0&&(i={});var a=i.newline_char,s=a===void 0?`\r?
`:a,u=i.sloppy,g=u===void 0?!1:u,d=function(B){return B.replace(/\\/g,"\\")},_=function(B,$){for(var ie=$.newline_char,ae={},ee=B.split(new RegExp(d(ie))),X="",oe="",te=0;te<ee.length;te++)X=ee[te].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),oe=ee[te].replace(/^\[[A-Za-z]+\s"(.*)" *\]$/,"$1"),X.trim().length>0&&(ae[X.trim()]=oe);return ae},c=new RegExp("^(\\[((?:"+d(s)+")|.)*\\])(?:"+d(s)+"){2}"),E=c.test(n)?c.exec(n)[1]:"",O=b(e.DEFAULT_POSITION),C=_(E,{newline_char:s});if(C.SetUp==="1"&&"FEN"in C){var w=b(C.FEN);if(!w)return null;O=w}for(var R=function(B){return Array.from(B).map(function($){return $.charCodeAt(0)<128?$.charCodeAt(0).toString(16):encodeURIComponent($).replace(/%/g,"").toLowerCase()}).join("")},I=function(B){var $;return B.length==0?"":decodeURIComponent("%"+(($=B?.match(/.{1,2}/g))===null||$===void 0?void 0:$.join("%")))},M=function(B){return B=B.replace(new RegExp(d(s),"g")," "),"{"+R(B.slice(1,B.length-1))+"}"},q=function(B){if(B.startsWith("{")&&B.endsWith("}"))return I(B.slice(1,B.length-1))},K=n.replace(E,"").replace(new RegExp("({[^}]*})+?|;([^"+d(s)+"]*)","g"),function(B,$,ie){return $!==void 0?M($):" "+M("{"+ie.slice(1)+"}")}).replace(new RegExp(d(s),"g")," "),L=/(\([^()]+\))+?/g;L.test(K);)K=K.replace(L,"");K=K.replace(/\d+\.(\.\.)?/g,""),K=K.replace(/\.\.\./g,""),K=K.replace(/\$\d+/g,"");for(var F=K.trim().split(new RegExp(/\s+/)).join(",").replace(/,,+/g,",").split(","),U={},Y=[],D=0;D<F.length;D++){var H=F[D],W=q(H);if(W!==void 0){U[O.fen]=W;continue}if(D===F.length-1&&e.POSSIBLE_RESULTS.indexOf(H)!==-1){Object.keys(C).length&&typeof C.Result>"u"&&(C.Result=H);continue}var G=N(O,F[D],{sloppy:g});if(G===null)return null;Y.push({move:G,state:O});var w=ne(O,G);if(!w)return null;O=w}return[O,C,U,Y]}S.loadPgn=f;function t(n,i){if(!i||(i=i.toLowerCase(),!r.isSquare(i)))return null;var a=e.SQUARES[i],s=n.board[a];return s?m(s):null}S.getPiece=t;function l(n){return{to:n.to,from:n.from,color:n.color,flags:n.flags,piece:n.piece,captured:n.captured,promotion:n.promotion,san:n.san}}S.cloneMove=l;function m(n){return{color:n.color,type:n.type}}S.clonePiece=m;function A(n,i,a){var s=i.type,u=i.color;if(!s||!u||!a||(s=s.toLowerCase(),u=u.toLowerCase(),a=a.toLowerCase(),!r.isPieceSymbol(s)||!r.isColor(u)||!r.isSquare(a)))return null;var g=n.clone(),d=e.SQUARES[a];return s===e.KING&&g.kings[u]!==e.EMPTY&&g.kings[u]!==d?null:(g.board[d]={type:s,color:u},s===e.KING&&(g.kings[u]=d),g)}S.putPiece=A;function P(n,i){if(!i||(i=i.toLowerCase(),!r.isSquare(i)))return null;var a=e.SQUARES[i],s=n.board[a];if(!s)return null;var u=n.clone(),g=s.type,d=s.color;return g===e.KING&&(u.kings[d]=e.EMPTY),delete u.board[a],u}S.removePiece=P;function p(n,i){var a,s;i===void 0&&(i={});var u=i.legal,g=u===void 0?!0:u,d=function(ie,ae,ee,X,oe){var te=ie[ee];if(te&&te.type===e.PAWN&&(r.rank(X)===e.RANK_8||r.rank(X)===e.RANK_1))for(var pe=[e.QUEEN,e.ROOK,e.BISHOP,e.KNIGHT],ce=0,Me=pe.length;ce<Me;ce++)ae.push(fe(n,ee,X,oe,pe[ce]));else ae.push(fe(n,ee,X,oe))},_=[],c=n.turn,E=r.swapColor(c),O={b:e.RANK_7,w:e.RANK_2},C=e.SQUARES.a8,w=e.SQUARES.h1,R=!1,I=i.square;if(I)if(I=I.toLowerCase(),r.isSquare(I))C=w=e.SQUARES[I],R=!0;else return[];for(var M=C;M<=w;M++){if(M&136){M+=7;continue}var q=n.board[M];if(!(!q||q.color!==c))if(q.type===e.PAWN){var K=M+e.PAWN_OFFSETS[c][0];if(!n.board[K]){d(n.board,_,M,K,e.BITS.NORMAL);var L=M+e.PAWN_OFFSETS[c][1];O[c]===r.rank(M)&&!n.board[L]&&d(n.board,_,M,L,e.BITS.BIG_PAWN)}for(var F=2;F<4;F++){var U=M+e.PAWN_OFFSETS[c][F];U&136||(n.board[U]&&((a=n.board[U])===null||a===void 0?void 0:a.color)===E?d(n.board,_,M,U,e.BITS.CAPTURE):U===n.ep_square&&d(n.board,_,M,n.ep_square,e.BITS.EP_CAPTURE))}}else for(var F=0,Y=e.PIECE_OFFSETS[q.type].length;F<Y;F++)for(var D=e.PIECE_OFFSETS[q.type][F],H=M;H+=D,!(H&136);){if(!n.board[H])d(n.board,_,M,H,e.BITS.NORMAL);else{if(((s=n.board[H])===null||s===void 0?void 0:s.color)===c)break;d(n.board,_,M,H,e.BITS.CAPTURE);break}if(q.type==="n"||q.type==="k")break}}if(!R||w===n.kings[c]){if(n.castling[c]&e.BITS.KSIDE_CASTLE){var W=n.kings[c],G=W+2;!n.board[W+1]&&!n.board[G]&&!Q(n,E,n.kings[c])&&!Q(n,E,W+1)&&!Q(n,E,G)&&d(n.board,_,n.kings[c],G,e.BITS.KSIDE_CASTLE)}if(n.castling[c]&e.BITS.QSIDE_CASTLE){var W=n.kings[c],G=W-2;!n.board[W-1]&&!n.board[W-2]&&!n.board[W-3]&&!Q(n,E,n.kings[c])&&!Q(n,E,W-1)&&!Q(n,E,G)&&d(n.board,_,n.kings[c],G,e.BITS.QSIDE_CASTLE)}}if(!g)return _;for(var B=[],M=0,Y=_.length;M<Y;M++){var $=ne(n,_[M]);x($,c)||B.push(_[M])}return B}S.generateMoves=p;function y(n,i,a){var s;a===void 0&&(a={});var u=a.sloppy,g=u===void 0?!1:u,d=a.checkPromotion,_=d===void 0?!0:d,c="";if(i.flags&e.BITS.KSIDE_CASTLE)c="O-O";else if(i.flags&e.BITS.QSIDE_CASTLE)c="O-O-O";else{var E=v(n,i,g);i.piece!==e.PAWN&&(c+=i.piece.toUpperCase()+E),i.flags&(e.BITS.CAPTURE|e.BITS.EP_CAPTURE)&&(i.piece===e.PAWN&&(c+=r.algebraic(i.from)[0]),c+="x"),c+=r.algebraic(i.to),_&&i.flags&e.BITS.PROMOTION&&(c+="="+((s=i.promotion)===null||s===void 0?void 0:s.toUpperCase()))}var O=ne(n,i);return Z(O)&&(J(O)?c+="#":c+="+"),c}S.moveToSan=y;function N(n,i,a){a===void 0&&(a={});var s=a.sloppy,u=s===void 0?!1:s,g=a.checkPromotion,d=g===void 0?!0:g,_=r.strippedSan(i),c,E,O,C,w;u&&(c=_.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),c&&(E=c[1],O=c[2],C=c[3],w=c[4]));for(var R=p(n,{square:O}),I=0,M=R.length;I<M;I++){var q=y(n,R[I],{checkPromotion:d});if(_===r.strippedSan(q)||u&&_===r.strippedSan(y(n,R[I],a))||O&&C&&r.isSquare(O)&&r.isSquare(C)&&c&&(!E||E.toLowerCase()==R[I].piece)&&e.SQUARES[O]==R[I].from&&e.SQUARES[C]==R[I].to&&(!d||!w||w.toLowerCase()==R[I].promotion))return R[I]}return null}S.sanToMove=N;function j(n,i){var a=l(i),s="";for(var u in e.BITS)r.isFlagKey(u)&&e.BITS[u]&a.flags&&(s+=e.FLAGS[u]);return{to:r.algebraic(a.to),from:r.algebraic(a.from),color:a.color,flags:s,piece:a.piece,san:y(n,a),captured:a.captured,promotion:a.promotion}}S.makePretty=j;function Q(n,i,a){for(var s,u=e.SQUARES.a8;u<=e.SQUARES.h1;u++){if(u&136){u+=7;continue}if(!(n.board[u]==null||((s=n.board[u])===null||s===void 0?void 0:s.color)!==i)){var g=n.board[u],d=u-a,_=d+119;if(g&&e.ATTACKS[_]&1<<e.SHIFTS[g.type]){if(g.type===e.PAWN){if(d>0){if(g.color===e.WHITE)return!0}else if(g.color===e.BLACK)return!0;continue}if(g.type==="n"||g.type==="k")return!0;for(var c=e.RAYS[_],E=u+c,O=!1;E!==a;){if(n.board[E]){O=!0;break}E+=c}if(!O)return!0}}}return!1}S.isAttacked=Q;function x(n,i){return Q(n,r.swapColor(i),n.kings[i])}S.isKingAttacked=x;function Z(n){return x(n,n.turn)}S.inCheck=Z;function J(n){return Z(n)&&p(n).length===0}S.inCheckmate=J;function Pe(n){return!Z(n)&&p(n).length===0}S.inStalemate=Pe;function Ce(n){for(var i={},a=[],s=0,u=0,g=e.SQUARES.a8;g<=e.SQUARES.h1;g++){if(u=(u+1)%2,g&136){g+=7;continue}var d=n.board[g];d&&(i[d.type]=d.type in i?i[d.type]+1:1,d.type===e.BISHOP&&a.push(u),s++)}if(s===2)return!0;if(s===3&&(i[e.BISHOP]===1||i[e.KNIGHT]===1))return!0;if(s===i[e.BISHOP]+2){for(var _=0,c=a.length,g=0;g<c;g++)_+=a[g];if(_===0||_===c)return!0}return!1}S.insufficientMaterial=Ce;function ne(n,i){var a=n.clone(),s=a.turn,u=r.swapColor(s);a.board[i.to]=a.board[i.from],delete a.board[i.from],i.flags&e.BITS.EP_CAPTURE&&(a.turn===e.BLACK?delete a.board[i.to-16]:delete a.board[i.to+16]),i.flags&e.BITS.PROMOTION&&i.promotion&&r.isPieceSymbol(i.promotion)&&(a.board[i.to]={type:i.promotion,color:s});var g=a.board[i.to];if(g&&g.type===e.KING){if(a.kings[g.color]=i.to,i.flags&e.BITS.KSIDE_CASTLE){var d=i.to-1,_=i.to+1;a.board[d]=a.board[_],delete a.board[_]}else if(i.flags&e.BITS.QSIDE_CASTLE){var d=i.to+1,_=i.to-2;a.board[d]=a.board[_],delete a.board[_]}a.castling[s]=0}if(a.castling[s]){for(var c=0,E=e.ROOKS[s].length;c<E;c++)if(i.from===e.ROOKS[s][c].square&&a.castling[s]&e.ROOKS[s][c].flag){a.castling[s]^=e.ROOKS[s][c].flag;break}}if(a.castling[u]){for(var c=0,E=e.ROOKS[u].length;c<E;c++)if(i.to===e.ROOKS[u][c].square&&a.castling[u]&e.ROOKS[u][c].flag){a.castling[u]^=e.ROOKS[u][c].flag;break}}return i.flags&e.BITS.BIG_PAWN?a.turn==="b"?a.ep_square=i.to-16:a.ep_square=i.to+16:a.ep_square=e.EMPTY,i.piece===e.PAWN||i.flags&(e.BITS.CAPTURE|e.BITS.EP_CAPTURE)?a.half_moves=0:a.half_moves++,a.turn===e.BLACK&&a.move_number++,a.turn=r.swapColor(a.turn),a}S.makeMove=ne;function fe(n,i,a,s,u){var g,d={color:n.turn,from:i,to:a,flags:s,piece:n.board[i].type};return u&&r.isPieceSymbol(u)&&(d.flags|=e.BITS.PROMOTION,d.promotion=u),n.board[a]?d.captured=(g=n.board[a])===null||g===void 0?void 0:g.type:s&e.BITS.EP_CAPTURE&&(d.captured=e.PAWN),d}S.buildMove=fe;function Ie(n,i){i===void 0&&(i=`
`);var a=e.RANKS.map(function(s){for(var u=n.slice(s*16,s*16+8),g=[],d=0,_=u;d<_.length;d++){var c=_[d];g.push(c?" "+r.symbol(c)+" ":" . ")}var E=g.join("");return"87654321"[s]+" |"+E+"|"});return["  +------------------------+",a.join(i),"  +------------------------+","    a  b  c  d  e  f  g  h"].join(i)}S.ascii=Ie;function Oe(n){for(var i=[],a=[],s=e.SQUARES.a8;s<=e.SQUARES.h1;s++){var u=n[s];u==null?a.push(null):a.push({type:u.type,color:u.color}),s+1&136&&(i.push(a),a=[],s+=8)}return i}S.getBoard=Oe;function Re(n,i,a){a===void 0&&(a={});var s=a.checkPromotion,u=s===void 0?!0:s;if(typeof i=="string")return N(n,i,a);if(typeof i=="object")for(var g=p(n,{square:i.from}),d=0,_=g;d<_.length;d++){var c=_[d];if(i.from===r.algebraic(c.from)&&i.to===r.algebraic(c.to)&&(!u||!("promotion"in c)||i.promotion===c.promotion))return c}return null}return S.validateMove=Re,S}var ye;function Ne(){if(ye)return V;ye=1;var e=V&&V.__assign||function(){return e=Object.assign||function(f){for(var t,l=1,m=arguments.length;l<m;l++){t=arguments[l];for(var A in t)Object.prototype.hasOwnProperty.call(t,A)&&(f[A]=t[A])}return f},e.apply(this,arguments)},o=V&&V.__spreadArrays||function(){for(var f=0,t=0,l=arguments.length;t<l;t++)f+=arguments[t].length;for(var m=Array(f),A=0,t=0;t<l;t++)for(var P=arguments[t],p=0,y=P.length;p<y;p++,A++)m[A]=P[p];return m};Object.defineProperty(V,"__esModule",{value:!0}),V.Chess=void 0;var r=Te(),v=de(),h=me(),b=le(),T=(function(){function f(t){if(t===void 0&&(t=b.DEFAULT_POSITION),this._state=new v.State,this._history=[],this._header={},this._comments={},!this.load(t))throw new Error("Error loading fen")}return Object.defineProperty(f.prototype,"state",{get:function(){return this._state.clone()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"states",{get:function(){return o(this._history.map(function(t){return t.state.clone()}),[this.state])},enumerable:!1,configurable:!0}),f.prototype.load=function(t,l){l===void 0&&(l=!1);var m=r.loadFen(t);return m?(this._state=m,this._history=[],l||(this._header={}),this._comments={},this.updateSetup(),!0):!1},f.prototype.clear=function(t){t===void 0&&(t=!1),this._state=new v.State,this._history=[],t||(this._header={}),this._comments={},this.updateSetup()},f.prototype.reset=function(){this.load(b.DEFAULT_POSITION)},f.prototype.get=function(t){return r.getPiece(this._state,t)},f.prototype.put=function(t,l){var m=r.putPiece(this._state,t,l);return m?(this._state=m,this.updateSetup(),!0):!1},f.prototype.remove=function(t){var l=r.getPiece(this._state,t);if(!l)return null;var m=r.removePiece(this._state,t);return m?(this._state=m,l):null},f.prototype.moves=function(t){var l=this;t===void 0&&(t={});var m=t.square,A=t.verbose,P=A===void 0?!1:A,p=r.generateMoves(this._state,{square:m});return P?p.map(function(y){return r.makePretty(l._state,y)}):p.map(function(y){return r.moveToSan(l._state,y)})},f.prototype.fen=function(){return this._state.fen},f.prototype.inCheck=function(){return r.inCheck(this._state)},f.prototype.inCheckmate=function(){return r.inCheckmate(this._state)},f.prototype.inStalemate=function(){return r.inStalemate(this._state)},f.prototype.insufficientMaterial=function(){return r.insufficientMaterial(this._state)},f.prototype.inThreefoldRepetition=function(){for(var t={},l=function(p){var y=p.fen.split(" ").slice(0,4).join(" ");return t[y]=y in t?t[y]+1:1,t[y]>=3},m=0,A=this._history;m<A.length;m++){var P=A[m].state;if(l(P))return!0}return l(this._state)},f.prototype.inDraw=function(){return this._state.half_moves>=100||this.inStalemate()||this.insufficientMaterial()||this.inThreefoldRepetition()},f.prototype.gameOver=function(){return this.inCheckmate()||this.inDraw()},f.prototype.board=function(){return r.getBoard(this._state.board)},f.prototype.pgn=function(t){return t===void 0&&(t={}),r.getPgn(this._state,this._header,this._comments,this._history,t)},f.prototype.loadPgn=function(t,l){l===void 0&&(l={});var m=r.loadPgn(t,l);if(!m)return!1;var A=m[0],P=m[1],p=m[2],y=m[3];return this._state=A,this._header=P,this._comments=p,this._history=y,!0},f.prototype.header=function(){return this._header},f.prototype.setHeader=function(t){this._header=t},f.prototype.addHeader=function(t,l){this._header[t]=l},f.prototype.removeHeader=function(t){delete this._header[t]},f.prototype.clearHeader=function(){this._header={}},f.prototype.ascii=function(t){return t===void 0&&(t=`
`),r.ascii(this._state.board,t)},f.prototype.turn=function(){return this._state.turn},f.prototype.move=function(t,l){l===void 0&&(l={});var m=r.validateMove(this._state,t,l);if(!m)return null;var A=r.makePretty(this._state,m);return l.dry_run||this.makeMove(m),A},f.prototype.validateMoves=function(t,l){l===void 0&&(l={});for(var m=[],A=this._state,P=0,p=t;P<p.length;P++){var y=p[P],N=r.validateMove(A,y,l);if(!N)return null;m.push(r.makePretty(A,N)),A=r.makeMove(A,N)}return m},f.prototype.isPromotion=function(t,l){l===void 0&&(l={});var m=r.validateMove(this._state,t,e(e({},l),{checkPromotion:!1}));return m?!!(m.flags&b.BITS.PROMOTION):!1},f.prototype.undo=function(){var t=this.undoMove();return t?r.makePretty(this._state,t):null},f.prototype.squareColor=function(t){if(h.isSquare(t)){var l=b.SQUARES[t];return(h.rank(l)+h.file(l))%2===0?"light":"dark"}return null},f.prototype.history=function(t){t===void 0&&(t={});var l=t.verbose,m=l===void 0?!1:l;if(!this._history.length)return[];var A;return m?this._history.map(function(P){var p=P.move;return A=P.state,r.makePretty(A,p)}):this._history.map(function(P){var p=P.move;return A=P.state,r.moveToSan(A,p)})},f.prototype.getComment=function(t){return t=t||this.fen(),this._comments[t]},f.prototype.getComments=function(){var t=this;return this.pruneComments(),Object.keys(this._comments).map(function(l){return{fen:l,comment:t._comments[l]}})},f.prototype.setComment=function(t,l){l=l||this.fen(),this._comments[l]=t.replace("{","[").replace("}","]")},f.prototype.deleteComment=function(t){t=t||this.fen();var l=this._comments[t];return delete this._comments[t],l},f.prototype.deleteComments=function(){var t=this;return this.pruneComments(),Object.keys(this._comments).map(function(l){var m=t._comments[l];return delete t._comments[l],{fen:l,comment:m}})},f.prototype.validateFen=function(t){return h.validateFen(t)},f.prototype.clone=function(){var t=new f;return t._state=this._state,t._history=o(this._history),t._header=e({},this._header),t._comments=e({},this._comments),t},f.prototype.perft=function(t){for(var l=r.generateMoves(this._state,{legal:!1}),m=0,A=this._state.turn,P=0,p=l.length;P<p;P++){if(this.makeMove(l[P]),!this.kingAttacked(A))if(t-1>0){var y=this.perft(t-1);m+=y}else m++;this.undoMove()}return m},f.prototype.updateSetup=function(){var t=this._state.fen;this._history.length>0||(t!==b.DEFAULT_POSITION?(this._header.SetUp="1",this._header.FEN=t):(delete this._header.SetUp,delete this._header.FEN))},f.prototype.pruneComments=function(){var t=this,l={},m=function(P){P in t._comments&&(l[P]=t._comments[P])};this._history.forEach(function(P){var p=P.state;A=p,m(A.fen)});var A=this._state;m(A.fen),this._comments=l},f.prototype.strippedSan=function(t){return t.replace(/=/,"").replace(/[+#]?[?!]*$/,"")},f.prototype.attacked=function(t,l){return r.isAttacked(this._state,t,l)},f.prototype.kingAttacked=function(t){return this.attacked(h.swapColor(t),this._state.kings[t])},f.prototype.makeMove=function(t){this._history.push({move:t,state:this._state}),this._state=r.makeMove(this._state,t)},f.prototype.undoMove=function(){var t=this._history.pop();return t==null?null:(this._state=t.state,t.move)},f})();return V.Chess=T,V}var Ae;function ke(){return Ae||(Ae=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0});var o=Ne();Object.defineProperty(e,"Chess",{enumerable:!0,get:function(){return o.Chess}});var r=de();Object.defineProperty(e,"State",{enumerable:!0,get:function(){return r.State}});var v=le();Object.defineProperty(e,"WHITE",{enumerable:!0,get:function(){return v.WHITE}}),Object.defineProperty(e,"BLACK",{enumerable:!0,get:function(){return v.BLACK}}),Object.defineProperty(e,"PAWN",{enumerable:!0,get:function(){return v.PAWN}}),Object.defineProperty(e,"KNIGHT",{enumerable:!0,get:function(){return v.KNIGHT}}),Object.defineProperty(e,"BISHOP",{enumerable:!0,get:function(){return v.BISHOP}}),Object.defineProperty(e,"ROOK",{enumerable:!0,get:function(){return v.ROOK}}),Object.defineProperty(e,"QUEEN",{enumerable:!0,get:function(){return v.QUEEN}}),Object.defineProperty(e,"KING",{enumerable:!0,get:function(){return v.KING}}),Object.defineProperty(e,"EMPTY",{enumerable:!0,get:function(){return v.EMPTY}}),Object.defineProperty(e,"SQUARES",{enumerable:!0,get:function(){return v.SQUARES}}),Object.defineProperty(e,"FLAGS",{enumerable:!0,get:function(){return v.FLAGS}}),Object.defineProperty(e,"BITS",{enumerable:!0,get:function(){return v.BITS}});var h=me();Object.defineProperty(e,"rank",{enumerable:!0,get:function(){return h.rank}}),Object.defineProperty(e,"file",{enumerable:!0,get:function(){return h.file}}),Object.defineProperty(e,"algebraic",{enumerable:!0,get:function(){return h.algebraic}})})(he)),he}var re=ke();const Be="2.0.0";class z{constructor(o,r){this._currentBannedMove=null,this._history=[],this._turnNumber=1,this._isFirstMove=!0,this._indicatorConfig={pgn:!0,serialization:!0,san:!0},this.chess=new re.Chess,r?this.loadFromPGN(r):o&&this.loadFromFEN(o)}get turn(){return this._isFirstMove?"black":this.nextActionType()==="ban"?this.chess.turn()==="w"?"black":"white":this.chess.turn()==="w"?"white":"black"}get currentBannedMove(){return this._currentBannedMove}nextActionType(){return this._isFirstMove?"ban":this._currentBannedMove?"move":"ban"}play(o){try{return"ban"in o?this.playBan(o.ban):this.playMove(o.move)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}playBan(o){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.nextActionType()!=="ban")return{success:!1,error:"Expected a move, not a ban"};if(!this.legalBans().some(A=>A.from===o.from&&A.to===o.to))return{success:!1,error:`Invalid ban: ${o.from}-${o.to}`};this._currentBannedMove=o;const h=new re.Chess(this.chess.fen()),T=h.moves({verbose:!0}).filter(A=>!(A.from===o.from&&A.to===o.to)),f=T.length===0&&h.inCheck(),t=T.length===0&&!h.inCheck();let l=`${o.from}${o.to}`;this._indicatorConfig.san&&(f?l+="#":t?l+="=":h.inCheck()&&(l+="+"));const m={turnNumber:this._turnNumber,player:this.turn,actionType:"ban",action:o,fen:this.fen(),bannedMove:o,san:l};return this._history.push(m),this._isFirstMove&&(this._isFirstMove=!1),{success:!0,action:{ban:o},san:this._indicatorConfig.san?l:`${o.from}${o.to}`,newFen:this.fen(),gameOver:f||t,checkmate:f,stalemate:t}}playMove(o){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.nextActionType()!=="move")return{success:!1,error:"Expected a ban, not a move"};if(this.isBannedMove(o))return{success:!1,error:`Move ${o.from}-${o.to} is banned`};const r=this.chess.move({from:o.from,to:o.to,promotion:o.promotion});if(!r)return{success:!1,error:`Invalid move: ${o.from}-${o.to}`};const v={turnNumber:this._turnNumber,player:this.chess.turn()==="w"?"black":"white",actionType:"move",action:o,san:r.san,fen:this.fen(),bannedMove:this._currentBannedMove};this._history.push(v),this._currentBannedMove=null,this.chess.turn()==="w"&&this._turnNumber++;const h=this.chess.gameOver(),b=this.chess.inCheckmate(),T=this.chess.inStalemate();let f=r.san;return!this._indicatorConfig.san&&f&&(f=f.replace(/[+#=]$/,"")),{success:!0,action:{move:o},san:f,newFen:this.fen(),gameOver:h,checkmate:b,stalemate:T}}isBannedMove(o){return this._currentBannedMove?this._currentBannedMove.from===o.from&&this._currentBannedMove.to===o.to:!1}legalMoves(){if(this.gameOver())return[];if(this.nextActionType()!=="move")return[];const r=this.chess.moves({verbose:!0}).map(v=>({from:v.from,to:v.to,promotion:v.promotion}));return this._currentBannedMove?r.filter(v=>!this.isBannedMove(v)):r}legalBans(){if(this.gameOver())return[];if(this.nextActionType()!=="ban")return[];const o=new re.Chess(this.chess.fen());if(this._isFirstMove)return o.moves({verbose:!0}).map(b=>({from:b.from,to:b.to}));o.load(this.chess.fen());const r=o.moves({verbose:!0}),v=new Map;return r.forEach(h=>{const b=`${h.from}-${h.to}`;v.has(b)||v.set(b,{from:h.from,to:h.to})}),Array.from(v.values())}inCheck(){return this.chess.inCheck()}inCheckmate(){return this.chess.inCheckmate()}inStalemate(){return this.chess.inStalemate()}gameOver(){return this.inCheckmate()||this.inStalemate()||this.inDraw()}inDraw(){return this.chess.inDraw()}inThreefoldRepetition(){return this.chess.inThreefoldRepetition()}insufficientMaterial(){return this.chess.insufficientMaterial()}currentPlayer(){return this.turn}setIndicatorConfig(o){this._indicatorConfig={...this._indicatorConfig,...o}}getIndicatorConfig(){return{...this._indicatorConfig}}nextMoveColor(){return this.chess.turn()==="w"?"white":"black"}fen(){const o=this.chess.fen();let r;return this._currentBannedMove?r=`b:${this._currentBannedMove.from}${this._currentBannedMove.to}`:this.nextActionType()==="ban"?r=`${this.turn.charAt(0)}:ban`:r="b:ban",`${o} ${r}`}pgn(){let o="",r="",v=1;for(let h=0;h<this._history.length;h++){const b=this._history[h];if(b.actionType==="ban"){const T=b.action;let f=`${T.from}${T.to}`;if(this._indicatorConfig.pgn&&b.san){const t=b.san.match(/[+#=]$/)?.[0];t&&(f+=t)}r+=`{banning: ${f}} `}else{b.player==="white"&&(r=`${v}. ${r}`);let T=b.san||"";!this._indicatorConfig.pgn&&T&&(T=T.replace(/[+#=]$/,"")),r+=`${T} `,b.player==="black"&&(o+=r,r="",v++)}}if(r&&(r.startsWith(`${v}.`)||(r=`${v}. ${r}`),o+=r),this._history.length>0){const h=this._history[this._history.length-1];if(h.actionType==="move"&&h.san){if(h.san.endsWith("#")){const b=h.player==="white"?"1-0":"0-1";o=o.trim()+" "+b}}else if(h.actionType==="ban"&&this.gameOver())if(this.inCheckmate()){const b=this.chess.turn()==="w"?"0-1":"1-0";o=o.trim()+" "+b}else this.inStalemate()&&(o=o.trim()+" 1/2-1/2")}return o.trim()}history(){return[...this._history]}reset(){this.chess=new re.Chess,this._currentBannedMove=null,this._history=[],this._turnNumber=1,this._isFirstMove=!0}ascii(){let o=this.chess.ascii();return this._currentBannedMove&&(o+=`
Banned: ${this._currentBannedMove.from}-${this._currentBannedMove.to}`),o+=`
Next: ${this.nextActionType()} by ${this.turn}`,o}static serializeAction(o,r){let v;if("ban"in o)v=`b:${o.ban.from}${o.ban.to}`;else{const h=o.move;v=`m:${h.from}${h.to}${h.promotion||""}`}return r&&(v+=r),v}static deserializeAction(o){const r=o.match(/^([bm]):([a-h][1-8])([a-h][1-8])([qrbn])?([+#=])?$/);if(!r)throw new Error(`Invalid serialized action format: ${o}`);const[,v,h,b,T,f]=r;if(v==="b")return{ban:{from:h,to:b}};{const t={from:h,to:b};return T&&(t.promotion=T),{move:t}}}getLastActionSerialized(){if(this._history.length===0)return null;const o=this._history[this._history.length-1],r=o.actionType==="ban"?{ban:o.action}:{move:o.action};if(!this._indicatorConfig.serialization)return z.serializeAction(r);let v;if(o.san){const h=o.san.match(/[+#=]$/);h&&(v=h[0])}return z.serializeAction(r,v)}getSyncState(){return{fen:this.fen(),lastAction:this.getLastActionSerialized()||void 0,moveNumber:this._turnNumber}}playSerializedAction(o){try{const r=z.deserializeAction(o);return this.play(r)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Invalid serialized action"}}}loadFromSyncState(o){this.loadFromFEN(o.fen),this._turnNumber=o.moveNumber}getActionHistory(){return this._history.map((o,r)=>{const v=o.actionType==="ban"?{ban:o.action}:{move:o.action};if(!this._indicatorConfig.serialization)return z.serializeAction(v);let h;return o.actionType==="move"?o.san?.endsWith("#")?h="#":o.san?.endsWith("+")&&(h="+"):r===this._history.length-1&&(this.gameOver()?this.inCheckmate()?h="#":this.inStalemate()&&(h="="):this.nextActionType()==="move"&&this.chess.inCheck()&&(h="+")),z.serializeAction(v,h)})}static replayFromActions(o,r){const v=new z(r);for(const h of o){const b=v.playSerializedAction(h);if(!b.success)throw new Error(`Failed to replay action ${h}: ${b.error}`)}return v}loadFromFEN(o){const r=o.split(" ");if(r.length<7){this.chess=new re.Chess(o);return}const v=r.slice(0,6).join(" "),h=r[6];if(this.chess=new re.Chess(v),h&&h!=="-"&&h.includes(":")){const[,b]=h.split(":");b==="ban"?this._isFirstMove=!1:b.length===4&&(this._currentBannedMove={from:b.substring(0,2),to:b.substring(2,4)},this._isFirstMove=!1)}}loadFromPGN(o){this.reset();const r=o.match(/\{banning:\s*[a-h][1-8][a-h][1-8]\}|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](?:=[QRBN])?[+#]?|\d+\./g);if(r){for(const v of r)if(!/^\d+\.$/.test(v)){if(v.includes("banning:")){const h=v.match(/([a-h][1-8])([a-h][1-8])/);if(h){const b={from:h[1],to:h[2]};this.play({ban:b})}}else if(/^[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8]/.test(v)){const b=this.legalMoves().find(T=>{const t=new re.Chess(this.chess.fen()).move({from:T.from,to:T.to,promotion:T.promotion});return t&&t.san===v});b&&this.play({move:b})}}}}}z.VERSION=Be;let ue=null,Ee=null;self.onmessage=async e=>{const{type:o,payload:r}=e.data;switch(o){case"INIT":ue={findBestMove:T=>{const f=T.nextActionType(),t=f==="move"?T.legalMoves():T.legalBans();if(t.length===0)return null;const l=t.map(A=>f==="move"?{move:A}:{ban:A}),m=Math.floor(Math.random()*Math.min(3,l.length));return{action:l[m],score:Math.random()*200-100,depth:r.depth||4,nodes:Math.floor(Math.random()*1e4)}},evaluatePosition:T=>{const t=T.fen().split(" ")[0];let l=0,m=0;const A={p:1,n:3,b:3,r:5,q:9,k:100};for(const y of t){if(y==="/"||y>="1"&&y<="8")continue;const N=y===y.toUpperCase(),j=A[y.toLowerCase()]||0;N?l+=j:m+=j}const p=T.turn==="white"?l-m:m-l;return{material:p*100,mobility:(T.legalMoves().length+T.legalBans().length)*10,kingBanSafety:0,centerControl:0,totalScore:p*100}}},self.postMessage({type:"READY"});break;case"FIND_BEST_MOVE":if(!ue){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}const v=new z(r.fen),h=ue.findBestMove(v);self.postMessage({type:"BEST_MOVE",move:h.action,evaluation:h.score,depth:h.depth,nodes:h.nodesSearched,pv:h.pv});break;case"ANALYZE_POSITION":if(!ue){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}const b=new z(r.fen);Ee=ue.evaluatePosition(b),self.postMessage({type:"ANALYSIS",analysis:Ee});break;case"GET_TT_STATS":self.postMessage({type:"TT_STATS",stats:{size:1e3,hits:350,hitRate:.35}});break}};
