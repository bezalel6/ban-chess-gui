var he={},V={},S={},ve={},me;function ce(){return me||(me=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ROOKS=e.SQUARES=e.RANKS=e.RANK_8=e.RANK_7=e.RANK_6=e.RANK_5=e.RANK_4=e.RANK_3=e.RANK_2=e.RANK_1=e.BITS=e.FLAGS=e.SHIFTS=e.RAYS=e.ATTACKS=e.PIECE_OFFSETS=e.PAWN_OFFSETS=e.POSSIBLE_RESULTS=e.DEFAULT_POSITION=e.SYMBOLS=e.EMPTY=e.KING=e.QUEEN=e.ROOK=e.BISHOP=e.KNIGHT=e.PAWN=e.BLACK=e.WHITE=void 0,e.WHITE="w",e.BLACK="b",e.PAWN="p",e.KNIGHT="n",e.BISHOP="b",e.ROOK="r",e.QUEEN="q",e.KING="k",e.EMPTY=-1,e.SYMBOLS="pnbrqkPNBRQK",e.DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",e.POSSIBLE_RESULTS=["1-0","0-1","1/2-1/2","*"],e.PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},e.PIECE_OFFSETS={p:[],n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},e.ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],e.RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],e.SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5},e.FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},e.BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},e.RANK_1=7,e.RANK_2=6,e.RANK_3=5,e.RANK_4=4,e.RANK_5=3,e.RANK_6=2,e.RANK_7=1,e.RANK_8=0,e.RANKS=[e.RANK_8,e.RANK_7,e.RANK_6,e.RANK_5,e.RANK_4,e.RANK_3,e.RANK_2,e.RANK_1],e.SQUARES={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},e.ROOKS={w:[{square:e.SQUARES.a1,flag:e.BITS.QSIDE_CASTLE},{square:e.SQUARES.h1,flag:e.BITS.KSIDE_CASTLE}],b:[{square:e.SQUARES.a8,flag:e.BITS.QSIDE_CASTLE},{square:e.SQUARES.h8,flag:e.BITS.KSIDE_CASTLE}]}})(ve)),ve}var se={},_e;function de(){if(_e)return se;_e=1,Object.defineProperty(se,"__esModule",{value:!0}),se.State=void 0;var e=ce(),a=Te(),r=(function(){function c(l,E,T,h,t,f,p){this.board=l||new Array(128),this.kings=E||{w:e.EMPTY,b:e.EMPTY},this.turn=T||e.WHITE,this.castling=h||{w:0,b:0},this.ep_square=t||e.EMPTY,this.half_moves=f||0,this.move_number=p||1}return c.prototype.clone=function(){return new c(this.board.slice(),{w:this.kings.w,b:this.kings.b},this.turn,{w:this.castling.w,b:this.castling.b},this.ep_square,this.half_moves,this.move_number)},Object.defineProperty(c.prototype,"fen",{get:function(){return a.getFen(this)},enumerable:!1,configurable:!0}),c})();return se.State=r,se}var N={},Se;function pe(){if(Se)return N;Se=1,Object.defineProperty(N,"__esModule",{value:!0}),N.strippedSan=N.validateFen=N.isFlagKey=N.isSquare=N.isPieceSymbol=N.isColor=N.symbol=N.isDigit=N.swapColor=N.algebraic=N.file=N.rank=void 0;var e=ce();function a(g){return g>>4}N.rank=a;function r(g){return g&15}N.file=r;function c(g){var y=r(g),M=a(g);return"abcdefgh".substring(y,y+1)+"87654321".substring(M,M+1)}N.algebraic=c;function l(g){return g===e.WHITE?e.BLACK:e.WHITE}N.swapColor=l;function E(g){return/^[0-9]$/.test(g)}N.isDigit=E;function T(g){var y=g.type,M=g.color;return M===e.WHITE?y.toUpperCase():y.toLowerCase()}N.symbol=T;function h(g){return g==="w"||g==="b"}N.isColor=h;function t(g){return/^[pnbrqk]$/.test(g)}N.isPieceSymbol=t;function f(g){return/^[a-h][1-8]$/.test(g)}N.isSquare=f;function p(g){var y=["NORMAL","CAPTURE","BIG_PAWN","EP_CAPTURE","PROMOTION","KSIDE_CASTLE","QSIDE_CASTLE"];return y.indexOf(g)!==-1}N.isFlagKey=p;function b(g){var y={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},M=g.split(/\s+/);if(M.length!==6)return{valid:!1,error_number:1,error:y[1]};if(isNaN(M[5])||parseInt(M[5],10)<=0)return{valid:!1,error_number:2,error:y[2]};if(isNaN(M[4])||parseInt(M[4],10)<0)return{valid:!1,error_number:3,error:y[3]};if(!/^(-|[abcdefgh][36])$/.test(M[3]))return{valid:!1,error_number:4,error:y[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(M[2]))return{valid:!1,error_number:5,error:y[5]};if(!/^(w|b)$/.test(M[1]))return{valid:!1,error_number:6,error:y[6]};var j=M[0].split("/");if(j.length!==8)return{valid:!1,error_number:7,error:y[7]};for(var $=0;$<j.length;$++){for(var x=0,Z=!1,J=0;J<j[$].length;J++)if(isNaN(j[$][J])){if(!/^[prnbqkPRNBQK]$/.test(j[$][J]))return{valid:!1,error_number:9,error:y[9]};x+=1,Z=!1}else{if(Z)return{valid:!1,error_number:8,error:y[8]};x+=parseInt(j[$][J],10),Z=!0}if(x!==8)return{valid:!1,error_number:10,error:y[10]}}return M[3][1]=="3"&&M[1]=="w"||M[3][1]=="6"&&M[1]=="b"?{valid:!1,error_number:11,error:y[11]}:{valid:!0,error_number:0,error:y[0]}}N.validateFen=b;function C(g){return g.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}return N.strippedSan=C,N}var ye;function Te(){if(ye)return S;ye=1,Object.defineProperty(S,"__esModule",{value:!0}),S.validateMove=S.getBoard=S.ascii=S.buildMove=S.makeMove=S.insufficientMaterial=S.inStalemate=S.inCheckmate=S.inCheck=S.isKingAttacked=S.isAttacked=S.makePretty=S.sanToMove=S.moveToSan=S.generateMoves=S.removePiece=S.putPiece=S.clonePiece=S.cloneMove=S.getPiece=S.loadPgn=S.getPgn=S.loadFen=S.getFen=S.getDisambiguator=void 0;var e=ce(),a=de(),r=pe();function c(n,i,o){for(var s=g(n,{legal:!o}),u=i.from,m=i.to,d=i.piece,_=0,v=0,A=0,O=0,P=s.length;O<P;O++){var w=s[O].from,R=s[O].to,I=s[O].piece;d===I&&u!==w&&m===R&&(_++,r.rank(u)===r.rank(w)&&v++,r.file(u)===r.file(w)&&A++)}return _>0?v>0&&A>0?r.algebraic(u):A>0?r.algebraic(u).charAt(1):r.algebraic(u).charAt(0):""}S.getDisambiguator=c;function l(n){for(var i=0,o="",s=e.SQUARES.a8;s<=e.SQUARES.h1;s++){var u=n.board[s];if(!u)i++;else{i>0&&(o+=i,i=0);var m=u.color,d=u.type;o+=m===e.WHITE?d.toUpperCase():d.toLowerCase()}s+1&136&&(i>0&&(o+=i),s!==e.SQUARES.h1&&(o+="/"),i=0,s+=8)}var _="";n.castling[e.WHITE]&e.BITS.KSIDE_CASTLE&&(_+="K"),n.castling[e.WHITE]&e.BITS.QSIDE_CASTLE&&(_+="Q"),n.castling[e.BLACK]&e.BITS.KSIDE_CASTLE&&(_+="k"),n.castling[e.BLACK]&e.BITS.QSIDE_CASTLE&&(_+="q"),_=_||"-";var v=n.ep_square===e.EMPTY?"-":r.algebraic(n.ep_square);return[o,n.turn,_,v,n.half_moves,n.move_number].join(" ")}S.getFen=l;function E(n){var i=n.split(/\s+/),o=i[0],s=0;if(!r.validateFen(n).valid)return null;for(var u=new a.State,m=0;m<o.length;m++){var d=o.charAt(m);if(d==="/")s+=8;else if(r.isDigit(d))s+=parseInt(d,10);else{var _=d<"a"?e.WHITE:e.BLACK,v=b(u,{type:d.toLowerCase(),color:_},r.algebraic(s));if(!v)return null;u=v,s++}}return u.turn=i[1]===e.BLACK?e.BLACK:e.WHITE,i[2].indexOf("K")>-1&&(u.castling.w|=e.BITS.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(u.castling.w|=e.BITS.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(u.castling.b|=e.BITS.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(u.castling.b|=e.BITS.QSIDE_CASTLE),u.ep_square=i[3]==="-"?e.EMPTY:e.SQUARES[i[3]],u.half_moves=parseInt(i[4],10),u.move_number=parseInt(i[5],10),u}S.loadFen=E;function T(n,i,o,s,u){u===void 0&&(u={});var m=u.newline_char,d=m===void 0?`
`:m,_=u.max_width,v=_===void 0?0:_,A=[],O=!1;for(var P in i)A.push("["+P+' "'+i[P]+'"]'+d),O=!0;O&&s.length&&A.push(d);var w=function(L){var F=o[n.fen];if(typeof F<"u"){var U=L.length>0?" ":"";L=""+L+U+"{"+F+"}"}return L};s[0]&&(n=s[0].state);var R=[],I="";if(s.length===0&&R.push(w("")),s.forEach(function(L,F){var U=L.move;I=w(I),F===0&&U.color===e.BLACK?I=n.move_number+". ...":U.color===e.WHITE&&(I.length&&R.push(I),I=n.move_number+"."),I=I+" "+y(n,U),n=ne(n,U)}),I.length&&R.push(w(I)),typeof i.Result<"u"&&R.push(i.Result),v===0)return A.join("")+R.join(" ");for(var k=function(){return A.length>0&&A[A.length-1]===" "?(A.pop(),!0):!1},D=function(L,F){for(var U=0,Y=F.split(" ");U<Y.length;U++){var q=Y[U];if(q){if(L+q.length>v){for(;k();)L--;A.push(d),L=0}A.push(q),L+=q.length,A.push(" "),L++}}return k()&&L--,L},K=0,P=0;P<R.length;P++){if(K+R[P].length>v&&R[P].includes("{")){K=D(K,R[P]);continue}K+R[P].length>v&&P!==0?(A[A.length-1]===" "&&A.pop(),A.push(d),K=0):P!==0&&(A.push(" "),K++),A.push(R[P]),K+=R[P].length}return A.join("")}S.getPgn=T;function h(n,i){i===void 0&&(i={});var o=i.newline_char,s=o===void 0?`\r?
`:o,u=i.sloppy,m=u===void 0?!1:u,d=function(B){return B.replace(/\\/g,"\\")},_=function(B,Q){for(var ie=Q.newline_char,ae={},ee=B.split(new RegExp(d(ie))),X="",oe="",te=0;te<ee.length;te++)X=ee[te].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),oe=ee[te].replace(/^\[[A-Za-z]+\s"(.*)" *\]$/,"$1"),X.trim().length>0&&(ae[X.trim()]=oe);return ae},v=new RegExp("^(\\[((?:"+d(s)+")|.)*\\])(?:"+d(s)+"){2}"),A=v.test(n)?v.exec(n)[1]:"",O=E(e.DEFAULT_POSITION),P=_(A,{newline_char:s});if(P.SetUp==="1"&&"FEN"in P){var w=E(P.FEN);if(!w)return null;O=w}for(var R=function(B){return Array.from(B).map(function(Q){return Q.charCodeAt(0)<128?Q.charCodeAt(0).toString(16):encodeURIComponent(Q).replace(/%/g,"").toLowerCase()}).join("")},I=function(B){var Q;return B.length==0?"":decodeURIComponent("%"+((Q=B?.match(/.{1,2}/g))===null||Q===void 0?void 0:Q.join("%")))},k=function(B){return B=B.replace(new RegExp(d(s),"g")," "),"{"+R(B.slice(1,B.length-1))+"}"},D=function(B){if(B.startsWith("{")&&B.endsWith("}"))return I(B.slice(1,B.length-1))},K=n.replace(A,"").replace(new RegExp("({[^}]*})+?|;([^"+d(s)+"]*)","g"),function(B,Q,ie){return Q!==void 0?k(Q):" "+k("{"+ie.slice(1)+"}")}).replace(new RegExp(d(s),"g")," "),L=/(\([^()]+\))+?/g;L.test(K);)K=K.replace(L,"");K=K.replace(/\d+\.(\.\.)?/g,""),K=K.replace(/\.\.\./g,""),K=K.replace(/\$\d+/g,"");for(var F=K.trim().split(new RegExp(/\s+/)).join(",").replace(/,,+/g,",").split(","),U={},Y=[],q=0;q<F.length;q++){var G=F[q],W=D(G);if(W!==void 0){U[O.fen]=W;continue}if(q===F.length-1&&e.POSSIBLE_RESULTS.indexOf(G)!==-1){Object.keys(P).length&&typeof P.Result>"u"&&(P.Result=G);continue}var H=M(O,F[q],{sloppy:m});if(H===null)return null;Y.push({move:H,state:O});var w=ne(O,H);if(!w)return null;O=w}return[O,P,U,Y]}S.loadPgn=h;function t(n,i){if(!i||(i=i.toLowerCase(),!r.isSquare(i)))return null;var o=e.SQUARES[i],s=n.board[o];return s?p(s):null}S.getPiece=t;function f(n){return{to:n.to,from:n.from,color:n.color,flags:n.flags,piece:n.piece,captured:n.captured,promotion:n.promotion,san:n.san}}S.cloneMove=f;function p(n){return{color:n.color,type:n.type}}S.clonePiece=p;function b(n,i,o){var s=i.type,u=i.color;if(!s||!u||!o||(s=s.toLowerCase(),u=u.toLowerCase(),o=o.toLowerCase(),!r.isPieceSymbol(s)||!r.isColor(u)||!r.isSquare(o)))return null;var m=n.clone(),d=e.SQUARES[o];return s===e.KING&&m.kings[u]!==e.EMPTY&&m.kings[u]!==d?null:(m.board[d]={type:s,color:u},s===e.KING&&(m.kings[u]=d),m)}S.putPiece=b;function C(n,i){if(!i||(i=i.toLowerCase(),!r.isSquare(i)))return null;var o=e.SQUARES[i],s=n.board[o];if(!s)return null;var u=n.clone(),m=s.type,d=s.color;return m===e.KING&&(u.kings[d]=e.EMPTY),delete u.board[o],u}S.removePiece=C;function g(n,i){var o,s;i===void 0&&(i={});var u=i.legal,m=u===void 0?!0:u,d=function(ie,ae,ee,X,oe){var te=ie[ee];if(te&&te.type===e.PAWN&&(r.rank(X)===e.RANK_8||r.rank(X)===e.RANK_1))for(var ge=[e.QUEEN,e.ROOK,e.BISHOP,e.KNIGHT],fe=0,ke=ge.length;fe<ke;fe++)ae.push(ue(n,ee,X,oe,ge[fe]));else ae.push(ue(n,ee,X,oe))},_=[],v=n.turn,A=r.swapColor(v),O={b:e.RANK_7,w:e.RANK_2},P=e.SQUARES.a8,w=e.SQUARES.h1,R=!1,I=i.square;if(I)if(I=I.toLowerCase(),r.isSquare(I))P=w=e.SQUARES[I],R=!0;else return[];for(var k=P;k<=w;k++){if(k&136){k+=7;continue}var D=n.board[k];if(!(!D||D.color!==v))if(D.type===e.PAWN){var K=k+e.PAWN_OFFSETS[v][0];if(!n.board[K]){d(n.board,_,k,K,e.BITS.NORMAL);var L=k+e.PAWN_OFFSETS[v][1];O[v]===r.rank(k)&&!n.board[L]&&d(n.board,_,k,L,e.BITS.BIG_PAWN)}for(var F=2;F<4;F++){var U=k+e.PAWN_OFFSETS[v][F];U&136||(n.board[U]&&((o=n.board[U])===null||o===void 0?void 0:o.color)===A?d(n.board,_,k,U,e.BITS.CAPTURE):U===n.ep_square&&d(n.board,_,k,n.ep_square,e.BITS.EP_CAPTURE))}}else for(var F=0,Y=e.PIECE_OFFSETS[D.type].length;F<Y;F++)for(var q=e.PIECE_OFFSETS[D.type][F],G=k;G+=q,!(G&136);){if(!n.board[G])d(n.board,_,k,G,e.BITS.NORMAL);else{if(((s=n.board[G])===null||s===void 0?void 0:s.color)===v)break;d(n.board,_,k,G,e.BITS.CAPTURE);break}if(D.type==="n"||D.type==="k")break}}if(!R||w===n.kings[v]){if(n.castling[v]&e.BITS.KSIDE_CASTLE){var W=n.kings[v],H=W+2;!n.board[W+1]&&!n.board[H]&&!$(n,A,n.kings[v])&&!$(n,A,W+1)&&!$(n,A,H)&&d(n.board,_,n.kings[v],H,e.BITS.KSIDE_CASTLE)}if(n.castling[v]&e.BITS.QSIDE_CASTLE){var W=n.kings[v],H=W-2;!n.board[W-1]&&!n.board[W-2]&&!n.board[W-3]&&!$(n,A,n.kings[v])&&!$(n,A,W-1)&&!$(n,A,H)&&d(n.board,_,n.kings[v],H,e.BITS.QSIDE_CASTLE)}}if(!m)return _;for(var B=[],k=0,Y=_.length;k<Y;k++){var Q=ne(n,_[k]);x(Q,v)||B.push(_[k])}return B}S.generateMoves=g;function y(n,i,o){var s;o===void 0&&(o={});var u=o.sloppy,m=u===void 0?!1:u,d=o.checkPromotion,_=d===void 0?!0:d,v="";if(i.flags&e.BITS.KSIDE_CASTLE)v="O-O";else if(i.flags&e.BITS.QSIDE_CASTLE)v="O-O-O";else{var A=c(n,i,m);i.piece!==e.PAWN&&(v+=i.piece.toUpperCase()+A),i.flags&(e.BITS.CAPTURE|e.BITS.EP_CAPTURE)&&(i.piece===e.PAWN&&(v+=r.algebraic(i.from)[0]),v+="x"),v+=r.algebraic(i.to),_&&i.flags&e.BITS.PROMOTION&&(v+="="+((s=i.promotion)===null||s===void 0?void 0:s.toUpperCase()))}var O=ne(n,i);return Z(O)&&(J(O)?v+="#":v+="+"),v}S.moveToSan=y;function M(n,i,o){o===void 0&&(o={});var s=o.sloppy,u=s===void 0?!1:s,m=o.checkPromotion,d=m===void 0?!0:m,_=r.strippedSan(i),v,A,O,P,w;u&&(v=_.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),v&&(A=v[1],O=v[2],P=v[3],w=v[4]));for(var R=g(n,{square:O}),I=0,k=R.length;I<k;I++){var D=y(n,R[I],{checkPromotion:d});if(_===r.strippedSan(D)||u&&_===r.strippedSan(y(n,R[I],o))||O&&P&&r.isSquare(O)&&r.isSquare(P)&&v&&(!A||A.toLowerCase()==R[I].piece)&&e.SQUARES[O]==R[I].from&&e.SQUARES[P]==R[I].to&&(!d||!w||w.toLowerCase()==R[I].promotion))return R[I]}return null}S.sanToMove=M;function j(n,i){var o=f(i),s="";for(var u in e.BITS)r.isFlagKey(u)&&e.BITS[u]&o.flags&&(s+=e.FLAGS[u]);return{to:r.algebraic(o.to),from:r.algebraic(o.from),color:o.color,flags:s,piece:o.piece,san:y(n,o),captured:o.captured,promotion:o.promotion}}S.makePretty=j;function $(n,i,o){for(var s,u=e.SQUARES.a8;u<=e.SQUARES.h1;u++){if(u&136){u+=7;continue}if(!(n.board[u]==null||((s=n.board[u])===null||s===void 0?void 0:s.color)!==i)){var m=n.board[u],d=u-o,_=d+119;if(m&&e.ATTACKS[_]&1<<e.SHIFTS[m.type]){if(m.type===e.PAWN){if(d>0){if(m.color===e.WHITE)return!0}else if(m.color===e.BLACK)return!0;continue}if(m.type==="n"||m.type==="k")return!0;for(var v=e.RAYS[_],A=u+v,O=!1;A!==o;){if(n.board[A]){O=!0;break}A+=v}if(!O)return!0}}}return!1}S.isAttacked=$;function x(n,i){return $(n,r.swapColor(i),n.kings[i])}S.isKingAttacked=x;function Z(n){return x(n,n.turn)}S.inCheck=Z;function J(n){return Z(n)&&g(n).length===0}S.inCheckmate=J;function Ce(n){return!Z(n)&&g(n).length===0}S.inStalemate=Ce;function Pe(n){for(var i={},o=[],s=0,u=0,m=e.SQUARES.a8;m<=e.SQUARES.h1;m++){if(u=(u+1)%2,m&136){m+=7;continue}var d=n.board[m];d&&(i[d.type]=d.type in i?i[d.type]+1:1,d.type===e.BISHOP&&o.push(u),s++)}if(s===2)return!0;if(s===3&&(i[e.BISHOP]===1||i[e.KNIGHT]===1))return!0;if(s===i[e.BISHOP]+2){for(var _=0,v=o.length,m=0;m<v;m++)_+=o[m];if(_===0||_===v)return!0}return!1}S.insufficientMaterial=Pe;function ne(n,i){var o=n.clone(),s=o.turn,u=r.swapColor(s);o.board[i.to]=o.board[i.from],delete o.board[i.from],i.flags&e.BITS.EP_CAPTURE&&(o.turn===e.BLACK?delete o.board[i.to-16]:delete o.board[i.to+16]),i.flags&e.BITS.PROMOTION&&i.promotion&&r.isPieceSymbol(i.promotion)&&(o.board[i.to]={type:i.promotion,color:s});var m=o.board[i.to];if(m&&m.type===e.KING){if(o.kings[m.color]=i.to,i.flags&e.BITS.KSIDE_CASTLE){var d=i.to-1,_=i.to+1;o.board[d]=o.board[_],delete o.board[_]}else if(i.flags&e.BITS.QSIDE_CASTLE){var d=i.to+1,_=i.to-2;o.board[d]=o.board[_],delete o.board[_]}o.castling[s]=0}if(o.castling[s]){for(var v=0,A=e.ROOKS[s].length;v<A;v++)if(i.from===e.ROOKS[s][v].square&&o.castling[s]&e.ROOKS[s][v].flag){o.castling[s]^=e.ROOKS[s][v].flag;break}}if(o.castling[u]){for(var v=0,A=e.ROOKS[u].length;v<A;v++)if(i.to===e.ROOKS[u][v].square&&o.castling[u]&e.ROOKS[u][v].flag){o.castling[u]^=e.ROOKS[u][v].flag;break}}return i.flags&e.BITS.BIG_PAWN?o.turn==="b"?o.ep_square=i.to-16:o.ep_square=i.to+16:o.ep_square=e.EMPTY,i.piece===e.PAWN||i.flags&(e.BITS.CAPTURE|e.BITS.EP_CAPTURE)?o.half_moves=0:o.half_moves++,o.turn===e.BLACK&&o.move_number++,o.turn=r.swapColor(o.turn),o}S.makeMove=ne;function ue(n,i,o,s,u){var m,d={color:n.turn,from:i,to:o,flags:s,piece:n.board[i].type};return u&&r.isPieceSymbol(u)&&(d.flags|=e.BITS.PROMOTION,d.promotion=u),n.board[o]?d.captured=(m=n.board[o])===null||m===void 0?void 0:m.type:s&e.BITS.EP_CAPTURE&&(d.captured=e.PAWN),d}S.buildMove=ue;function Ie(n,i){i===void 0&&(i=`
`);var o=e.RANKS.map(function(s){for(var u=n.slice(s*16,s*16+8),m=[],d=0,_=u;d<_.length;d++){var v=_[d];m.push(v?" "+r.symbol(v)+" ":" . ")}var A=m.join("");return"87654321"[s]+" |"+A+"|"});return["  +------------------------+",o.join(i),"  +------------------------+","    a  b  c  d  e  f  g  h"].join(i)}S.ascii=Ie;function Oe(n){for(var i=[],o=[],s=e.SQUARES.a8;s<=e.SQUARES.h1;s++){var u=n[s];u==null?o.push(null):o.push({type:u.type,color:u.color}),s+1&136&&(i.push(o),o=[],s+=8)}return i}S.getBoard=Oe;function Re(n,i,o){o===void 0&&(o={});var s=o.checkPromotion,u=s===void 0?!0:s;if(typeof i=="string")return M(n,i,o);if(typeof i=="object")for(var m=g(n,{square:i.from}),d=0,_=m;d<_.length;d++){var v=_[d];if(i.from===r.algebraic(v.from)&&i.to===r.algebraic(v.to)&&(!u||!("promotion"in v)||i.promotion===v.promotion))return v}return null}return S.validateMove=Re,S}var be;function Me(){if(be)return V;be=1;var e=V&&V.__assign||function(){return e=Object.assign||function(h){for(var t,f=1,p=arguments.length;f<p;f++){t=arguments[f];for(var b in t)Object.prototype.hasOwnProperty.call(t,b)&&(h[b]=t[b])}return h},e.apply(this,arguments)},a=V&&V.__spreadArrays||function(){for(var h=0,t=0,f=arguments.length;t<f;t++)h+=arguments[t].length;for(var p=Array(h),b=0,t=0;t<f;t++)for(var C=arguments[t],g=0,y=C.length;g<y;g++,b++)p[b]=C[g];return p};Object.defineProperty(V,"__esModule",{value:!0}),V.Chess=void 0;var r=Te(),c=de(),l=pe(),E=ce(),T=(function(){function h(t){if(t===void 0&&(t=E.DEFAULT_POSITION),this._state=new c.State,this._history=[],this._header={},this._comments={},!this.load(t))throw new Error("Error loading fen")}return Object.defineProperty(h.prototype,"state",{get:function(){return this._state.clone()},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"states",{get:function(){return a(this._history.map(function(t){return t.state.clone()}),[this.state])},enumerable:!1,configurable:!0}),h.prototype.load=function(t,f){f===void 0&&(f=!1);var p=r.loadFen(t);return p?(this._state=p,this._history=[],f||(this._header={}),this._comments={},this.updateSetup(),!0):!1},h.prototype.clear=function(t){t===void 0&&(t=!1),this._state=new c.State,this._history=[],t||(this._header={}),this._comments={},this.updateSetup()},h.prototype.reset=function(){this.load(E.DEFAULT_POSITION)},h.prototype.get=function(t){return r.getPiece(this._state,t)},h.prototype.put=function(t,f){var p=r.putPiece(this._state,t,f);return p?(this._state=p,this.updateSetup(),!0):!1},h.prototype.remove=function(t){var f=r.getPiece(this._state,t);if(!f)return null;var p=r.removePiece(this._state,t);return p?(this._state=p,f):null},h.prototype.moves=function(t){var f=this;t===void 0&&(t={});var p=t.square,b=t.verbose,C=b===void 0?!1:b,g=r.generateMoves(this._state,{square:p});return C?g.map(function(y){return r.makePretty(f._state,y)}):g.map(function(y){return r.moveToSan(f._state,y)})},h.prototype.fen=function(){return this._state.fen},h.prototype.inCheck=function(){return r.inCheck(this._state)},h.prototype.inCheckmate=function(){return r.inCheckmate(this._state)},h.prototype.inStalemate=function(){return r.inStalemate(this._state)},h.prototype.insufficientMaterial=function(){return r.insufficientMaterial(this._state)},h.prototype.inThreefoldRepetition=function(){for(var t={},f=function(g){var y=g.fen.split(" ").slice(0,4).join(" ");return t[y]=y in t?t[y]+1:1,t[y]>=3},p=0,b=this._history;p<b.length;p++){var C=b[p].state;if(f(C))return!0}return f(this._state)},h.prototype.inDraw=function(){return this._state.half_moves>=100||this.inStalemate()||this.insufficientMaterial()||this.inThreefoldRepetition()},h.prototype.gameOver=function(){return this.inCheckmate()||this.inDraw()},h.prototype.board=function(){return r.getBoard(this._state.board)},h.prototype.pgn=function(t){return t===void 0&&(t={}),r.getPgn(this._state,this._header,this._comments,this._history,t)},h.prototype.loadPgn=function(t,f){f===void 0&&(f={});var p=r.loadPgn(t,f);if(!p)return!1;var b=p[0],C=p[1],g=p[2],y=p[3];return this._state=b,this._header=C,this._comments=g,this._history=y,!0},h.prototype.header=function(){return this._header},h.prototype.setHeader=function(t){this._header=t},h.prototype.addHeader=function(t,f){this._header[t]=f},h.prototype.removeHeader=function(t){delete this._header[t]},h.prototype.clearHeader=function(){this._header={}},h.prototype.ascii=function(t){return t===void 0&&(t=`
`),r.ascii(this._state.board,t)},h.prototype.turn=function(){return this._state.turn},h.prototype.move=function(t,f){f===void 0&&(f={});var p=r.validateMove(this._state,t,f);if(!p)return null;var b=r.makePretty(this._state,p);return f.dry_run||this.makeMove(p),b},h.prototype.validateMoves=function(t,f){f===void 0&&(f={});for(var p=[],b=this._state,C=0,g=t;C<g.length;C++){var y=g[C],M=r.validateMove(b,y,f);if(!M)return null;p.push(r.makePretty(b,M)),b=r.makeMove(b,M)}return p},h.prototype.isPromotion=function(t,f){f===void 0&&(f={});var p=r.validateMove(this._state,t,e(e({},f),{checkPromotion:!1}));return p?!!(p.flags&E.BITS.PROMOTION):!1},h.prototype.undo=function(){var t=this.undoMove();return t?r.makePretty(this._state,t):null},h.prototype.squareColor=function(t){if(l.isSquare(t)){var f=E.SQUARES[t];return(l.rank(f)+l.file(f))%2===0?"light":"dark"}return null},h.prototype.history=function(t){t===void 0&&(t={});var f=t.verbose,p=f===void 0?!1:f;if(!this._history.length)return[];var b;return p?this._history.map(function(C){var g=C.move;return b=C.state,r.makePretty(b,g)}):this._history.map(function(C){var g=C.move;return b=C.state,r.moveToSan(b,g)})},h.prototype.getComment=function(t){return t=t||this.fen(),this._comments[t]},h.prototype.getComments=function(){var t=this;return this.pruneComments(),Object.keys(this._comments).map(function(f){return{fen:f,comment:t._comments[f]}})},h.prototype.setComment=function(t,f){f=f||this.fen(),this._comments[f]=t.replace("{","[").replace("}","]")},h.prototype.deleteComment=function(t){t=t||this.fen();var f=this._comments[t];return delete this._comments[t],f},h.prototype.deleteComments=function(){var t=this;return this.pruneComments(),Object.keys(this._comments).map(function(f){var p=t._comments[f];return delete t._comments[f],{fen:f,comment:p}})},h.prototype.validateFen=function(t){return l.validateFen(t)},h.prototype.clone=function(){var t=new h;return t._state=this._state,t._history=a(this._history),t._header=e({},this._header),t._comments=e({},this._comments),t},h.prototype.perft=function(t){for(var f=r.generateMoves(this._state,{legal:!1}),p=0,b=this._state.turn,C=0,g=f.length;C<g;C++){if(this.makeMove(f[C]),!this.kingAttacked(b))if(t-1>0){var y=this.perft(t-1);p+=y}else p++;this.undoMove()}return p},h.prototype.updateSetup=function(){var t=this._state.fen;this._history.length>0||(t!==E.DEFAULT_POSITION?(this._header.SetUp="1",this._header.FEN=t):(delete this._header.SetUp,delete this._header.FEN))},h.prototype.pruneComments=function(){var t=this,f={},p=function(C){C in t._comments&&(f[C]=t._comments[C])};this._history.forEach(function(C){var g=C.state;b=g,p(b.fen)});var b=this._state;p(b.fen),this._comments=f},h.prototype.strippedSan=function(t){return t.replace(/=/,"").replace(/[+#]?[?!]*$/,"")},h.prototype.attacked=function(t,f){return r.isAttacked(this._state,t,f)},h.prototype.kingAttacked=function(t){return this.attacked(l.swapColor(t),this._state.kings[t])},h.prototype.makeMove=function(t){this._history.push({move:t,state:this._state}),this._state=r.makeMove(this._state,t)},h.prototype.undoMove=function(){var t=this._history.pop();return t==null?null:(this._state=t.state,t.move)},h})();return V.Chess=T,V}var Ae;function Ne(){return Ae||(Ae=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0});var a=Me();Object.defineProperty(e,"Chess",{enumerable:!0,get:function(){return a.Chess}});var r=de();Object.defineProperty(e,"State",{enumerable:!0,get:function(){return r.State}});var c=ce();Object.defineProperty(e,"WHITE",{enumerable:!0,get:function(){return c.WHITE}}),Object.defineProperty(e,"BLACK",{enumerable:!0,get:function(){return c.BLACK}}),Object.defineProperty(e,"PAWN",{enumerable:!0,get:function(){return c.PAWN}}),Object.defineProperty(e,"KNIGHT",{enumerable:!0,get:function(){return c.KNIGHT}}),Object.defineProperty(e,"BISHOP",{enumerable:!0,get:function(){return c.BISHOP}}),Object.defineProperty(e,"ROOK",{enumerable:!0,get:function(){return c.ROOK}}),Object.defineProperty(e,"QUEEN",{enumerable:!0,get:function(){return c.QUEEN}}),Object.defineProperty(e,"KING",{enumerable:!0,get:function(){return c.KING}}),Object.defineProperty(e,"EMPTY",{enumerable:!0,get:function(){return c.EMPTY}}),Object.defineProperty(e,"SQUARES",{enumerable:!0,get:function(){return c.SQUARES}}),Object.defineProperty(e,"FLAGS",{enumerable:!0,get:function(){return c.FLAGS}}),Object.defineProperty(e,"BITS",{enumerable:!0,get:function(){return c.BITS}});var l=pe();Object.defineProperty(e,"rank",{enumerable:!0,get:function(){return l.rank}}),Object.defineProperty(e,"file",{enumerable:!0,get:function(){return l.file}}),Object.defineProperty(e,"algebraic",{enumerable:!0,get:function(){return l.algebraic}})})(he)),he}var re=Ne();const Be="3.1.1";class z{constructor(a,r){this._currentBannedMove=null,this._history=[],this._ply=1,this._indicatorConfig={pgn:!0,serialization:!0,san:!0},this.chess=new re.Chess,r?this.loadFromPGN(r):a&&this.loadFromFEN(a)}getPly(){return this._ply}getActivePlayer(){switch((this._ply-1)%4+1){case 1:return"black";case 2:return"white";case 3:return"white";case 4:return"black";default:return"black"}}getActionType(){return this._ply%2===1?"ban":"move"}get turn(){return this.getActivePlayer()}get currentBannedMove(){return this._currentBannedMove}nextActionType(){return this.getActionType()}play(a){try{return"ban"in a?this.playBan(a.ban):this.playMove(a.move)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}playBan(a){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.getActionType()!=="ban")return{success:!1,error:"Expected a move, not a ban"};if(!this.legalBans().some(g=>g.from===a.from&&g.to===a.to))return{success:!1,error:`Invalid ban: ${a.from}-${a.to}`};this._currentBannedMove=a;const l=new re.Chess(this.chess.fen()),T=l.moves({verbose:!0}).filter(g=>!(g.from===a.from&&g.to===a.to)),h=T.length===0&&l.inCheck(),t=T.length===0&&!l.inCheck(),f=l.inCheck()&&T.length>0,p={check:f,checkmate:h,stalemate:t,gameOver:h||t,banCausedCheckmate:h,banCausedStalemate:t};let b=`${a.from}${a.to}`;this._indicatorConfig.san&&(h?b+="#":t?b+="=":f&&(b+="+"));const C={ply:this._ply,player:this.getActivePlayer(),actionType:"ban",action:a,fen:this.fen(),bannedMove:a,san:b,flags:p};return this._history.push(C),this._ply++,{success:!0,action:{ban:a},san:this._indicatorConfig.san?b:`${a.from}${a.to}`,newFen:this.fen(),flags:p,check:p.check,checkmate:p.checkmate,stalemate:p.stalemate,gameOver:p.gameOver,draw:p.draw}}playMove(a){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.getActionType()!=="move")return{success:!1,error:"Expected a ban, not a move"};if(this.isBannedMove(a))return{success:!1,error:`Move ${a.from}-${a.to} is banned`};const r=this.chess.move({from:a.from,to:a.to,promotion:a.promotion});if(!r)return{success:!1,error:`Invalid move: ${a.from}-${a.to}`};const c={check:this.chess.inCheck(),checkmate:this.chess.inCheckmate(),stalemate:this.chess.inStalemate(),draw:this.chess.inDraw(),gameOver:this.chess.gameOver(),insufficientMaterial:this.chess.insufficientMaterial(),threefoldRepetition:this.chess.inThreefoldRepetition(),fiftyMoveRule:this.chess.inDraw()&&!this.chess.inStalemate()&&!this.chess.insufficientMaterial()},l={ply:this._ply,player:this.getActivePlayer(),actionType:"move",action:a,san:r.san,fen:this.fen(),bannedMove:this._currentBannedMove,flags:c};this._history.push(l),this._currentBannedMove=null,this._ply++;let E=r.san;return!this._indicatorConfig.san&&E&&(E=E.replace(/[+#=]$/,"")),{success:!0,action:{move:a},san:E,newFen:this.fen(),flags:c,check:c.check,checkmate:c.checkmate,stalemate:c.stalemate,gameOver:c.gameOver,draw:c.draw}}isBannedMove(a){return this._currentBannedMove?this._currentBannedMove.from===a.from&&this._currentBannedMove.to===a.to:!1}getLegalActions(){return this.gameOver()?[]:this.getActionType()==="ban"?this.legalBans().map(a=>({ban:a})):this.legalMoves().map(a=>({move:a}))}legalMoves(){if(this.gameOver())return[];if(this.getActionType()!=="move")return[];const r=this.chess.moves({verbose:!0}).map(c=>({from:c.from,to:c.to,promotion:c.promotion}));return this._currentBannedMove?r.filter(c=>!this.isBannedMove(c)):r}legalBans(){if(this.gameOver())return[];if(this.getActionType()!=="ban")return[];const r=new re.Chess(this.chess.fen()).moves({verbose:!0}),c=new Map;return r.forEach(l=>{const E=`${l.from}-${l.to}`;c.has(E)||c.set(E,{from:l.from,to:l.to})}),Array.from(c.values())}inCheck(){return this.chess.inCheck()}inCheckmate(){return this.chess.inCheckmate()}inStalemate(){return this.chess.inStalemate()}gameOver(){return this.inCheckmate()||this.inStalemate()||this.inDraw()}inDraw(){return this.chess.inDraw()}inThreefoldRepetition(){return this.chess.inThreefoldRepetition()}insufficientMaterial(){return this.chess.insufficientMaterial()}currentPlayer(){return this.turn}setIndicatorConfig(a){this._indicatorConfig={...this._indicatorConfig,...a}}getIndicatorConfig(){return{...this._indicatorConfig}}nextMoveColor(){return this.chess.turn()==="w"?"white":"black"}getGameIndicator(){const a=this.getGameFlags();return a.checkmate?"#":a.stalemate||a.draw?"=":a.check?"+":""}getGameFlags(){const a=this._history[this._history.length-1],r=a?.flags?.banCausedCheckmate||!1,c=a?.flags?.banCausedStalemate||!1;return{check:this.chess.inCheck(),checkmate:this.chess.inCheckmate(),stalemate:this.chess.inStalemate(),draw:this.chess.inDraw(),gameOver:this.chess.gameOver(),insufficientMaterial:this.chess.insufficientMaterial(),threefoldRepetition:this.chess.inThreefoldRepetition(),fiftyMoveRule:this.chess.inDraw()&&!this.chess.inStalemate()&&!this.chess.insufficientMaterial()&&!this.chess.inThreefoldRepetition(),banCausedCheckmate:r,banCausedStalemate:c}}fen(){const a=this.chess.fen();let r=this._ply.toString();this._currentBannedMove&&(r+=`:${this._currentBannedMove.from}${this._currentBannedMove.to}`);const c=this.getGameIndicator();return r+=c,`${a} ${r}`}pgn(){let a="",r="";for(let c=0;c<this._history.length;c++){const l=this._history[c];let E=1;if(l.actionType==="move"&&(l.player==="white"?E=Math.floor((l.ply-2)/4)+1:E=Math.floor((l.ply-4)/4)+1),l.actionType==="ban"){const T=l.action;let h=`${T.from}${T.to}`;if(this._indicatorConfig.pgn&&l.san){const t=l.san.match(/[+#=]$/)?.[0];t&&(h+=t)}r+=`{banning: ${h}} `}else{l.player==="white"&&(r=`${E}. ${r}`);let T=l.san||"";!this._indicatorConfig.pgn&&T&&(T=T.replace(/[+#=]$/,"")),r+=`${T} `,l.player==="black"&&(a+=r,r="")}}if(r){const c=this._history.length>0?Math.floor((this._history[this._history.length-1].ply+1)/2):1;r.startsWith(`${c}.`)||(r=`${c}. ${r}`),a+=r}if(this._history.length>0){const c=this._history[this._history.length-1];if(c.actionType==="move"&&c.san){if(c.san.endsWith("#")){const l=c.player==="white"?"1-0":"0-1";a=a.trim()+" "+l}}else if(c.actionType==="ban"&&this.gameOver())if(this.inCheckmate()){const l=this.chess.turn()==="w"?"0-1":"1-0";a=a.trim()+" "+l}else this.inStalemate()&&(a=a.trim()+" 1/2-1/2")}return a.trim()}history(){return[...this._history]}reset(){this.chess=new re.Chess,this._currentBannedMove=null,this._history=[],this._ply=1}ascii(){let a=this.chess.ascii();return this._currentBannedMove&&(a+=`
Banned: ${this._currentBannedMove.from}-${this._currentBannedMove.to}`),a+=`
Ply: ${this._ply} (${this.getActionType()} by ${this.getActivePlayer()})`,a}static serializeAction(a,r){let c;if("ban"in a)c=`b:${a.ban.from}${a.ban.to}`;else{const l=a.move;c=`m:${l.from}${l.to}${l.promotion||""}`}return r&&(c+=r),c}static deserializeAction(a){const r=a.match(/^([bm]):([a-h][1-8])([a-h][1-8])([qrbn])?([+#=])?$/);if(!r)throw new Error(`Invalid serialized action format: ${a}`);const[,c,l,E,T,h]=r;return c==="b"?{ban:{from:l,to:E}}:{move:T?{from:l,to:E,promotion:T}:{from:l,to:E}}}getLastActionSerialized(){if(this._history.length===0)return null;const a=this._history[this._history.length-1],r=a.actionType==="ban"?{ban:a.action}:{move:a.action};if(!this._indicatorConfig.serialization)return z.serializeAction(r);let c;if(a.san){const l=a.san.match(/[+#=]$/);l&&(c=l[0])}return z.serializeAction(r,c)}getSyncState(){return{fen:this.fen(),lastAction:this.getLastActionSerialized()||void 0,ply:this._ply}}playSerializedAction(a){try{const r=z.deserializeAction(a);return this.play(r)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Invalid serialized action"}}}loadFromSyncState(a){this.loadFromFEN(a.fen),this._ply=a.ply}getActionLog(){return this._history.map(a=>{if(a.actionType==="ban"){const r=a.action;let c=`b:${r.from}${r.to}`;if(a.san&&this._indicatorConfig.serialization){const l=a.san.match(/[+#=]$/);l&&(c+=l[0])}return c}else return a.san||`${a.action.from}${a.action.to}`})}getActionHistory(){return this._history.map((a,r)=>{const c=a.actionType==="ban"?{ban:a.action}:{move:a.action};if(!this._indicatorConfig.serialization)return z.serializeAction(c);let l;return a.actionType==="move"?a.san?.endsWith("#")?l="#":a.san?.endsWith("+")&&(l="+"):r===this._history.length-1&&(this.gameOver()?this.inCheckmate()?l="#":this.inStalemate()&&(l="="):this.nextActionType()==="move"&&this.chess.inCheck()&&(l="+")),z.serializeAction(c,l)})}static replayFromActions(a,r){const c=new z(r);for(const l of a){const E=c.playSerializedAction(l);if(!E.success)throw new Error(`Failed to replay action ${l}: ${E.error}`)}return c}loadFromFEN(a){const r=a.split(" ");if(r.length<7){this.chess=new re.Chess(a);return}const c=r.slice(0,6).join(" ");let l=r[6];if(this.chess=new re.Chess(c),l&&l!=="-"){const E=l[l.length-1];if((E==="+"||E==="#"||E==="=")&&(l=l.slice(0,-1)),l.includes(":")){const[T,h]=l.split(":");this._ply=parseInt(T,10)||1,h&&h.length>=4&&(this._currentBannedMove={from:h.substring(0,2),to:h.substring(2,4)})}else{const T=parseInt(l,10);if(!isNaN(T))this._ply=T;else if(l.startsWith("b:")||l.startsWith("w:")){const[h,t]=l.split(":");t!=="ban"&&t.length===4&&(this._currentBannedMove={from:t.substring(0,2),to:t.substring(2,4)})}}}}loadFromPGN(a){this.reset();const r=a.match(/\{banning:\s*[a-h][1-8][a-h][1-8]\}|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](?:=[QRBN])?[+#]?|\d+\./g);if(r){for(const c of r)if(!/^\d+\.$/.test(c)){if(c.includes("banning:")){const l=c.match(/([a-h][1-8])([a-h][1-8])/);if(l){const E={from:l[1],to:l[2]};this.play({ban:E})}}else if(/^[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8]/.test(c)){const E=this.legalMoves().find(T=>{const t=new re.Chess(this.chess.fen()).move({from:T.from,to:T.to,promotion:T.promotion});return t&&t.san===c});E&&this.play({move:E})}}}}}z.VERSION=Be;let le=null,Ee=null;self.onmessage=async e=>{const{type:a,payload:r}=e.data;switch(a){case"INIT":le={findBestMove:T=>{const h=T.nextActionType(),t=h==="move"?T.legalMoves():T.legalBans();if(t.length===0)return null;const f=t.map(b=>h==="move"?{move:b}:{ban:b}),p=Math.floor(Math.random()*Math.min(3,f.length));return{action:f[p],score:Math.random()*200-100,depth:r.depth||4,nodes:Math.floor(Math.random()*1e4)}},evaluatePosition:T=>{const t=T.fen().split(" ")[0];let f=0,p=0;const b={p:1,n:3,b:3,r:5,q:9,k:100};for(const y of t){if(y==="/"||y>="1"&&y<="8")continue;const M=y===y.toUpperCase(),j=b[y.toLowerCase()]||0;M?f+=j:p+=j}const g=T.turn==="white"?f-p:p-f;return{material:g*100,mobility:(T.legalMoves().length+T.legalBans().length)*10,kingBanSafety:0,centerControl:0,totalScore:g*100}}},self.postMessage({type:"READY"});break;case"FIND_BEST_MOVE":if(!le){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}const c=new z(r.fen),l=le.findBestMove(c);self.postMessage({type:"BEST_MOVE",move:l.action,evaluation:l.score,depth:l.depth,nodes:l.nodesSearched,pv:l.pv});break;case"ANALYZE_POSITION":if(!le){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}const E=new z(r.fen);Ee=le.evaluatePosition(E),self.postMessage({type:"ANALYSIS",analysis:Ee});break;case"GET_TT_STATS":self.postMessage({type:"TT_STATS",stats:{size:1e3,hits:350,hitRate:.35}});break}};
