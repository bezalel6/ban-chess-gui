var Se={},x={},E={},be={},Te;function he(){return Te||(Te=1,(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.ROOKS=r.SQUARES=r.RANKS=r.RANK_8=r.RANK_7=r.RANK_6=r.RANK_5=r.RANK_4=r.RANK_3=r.RANK_2=r.RANK_1=r.BITS=r.FLAGS=r.SHIFTS=r.RAYS=r.ATTACKS=r.PIECE_OFFSETS=r.PAWN_OFFSETS=r.POSSIBLE_RESULTS=r.DEFAULT_POSITION=r.SYMBOLS=r.EMPTY=r.KING=r.QUEEN=r.ROOK=r.BISHOP=r.KNIGHT=r.PAWN=r.BLACK=r.WHITE=void 0,r.WHITE="w",r.BLACK="b",r.PAWN="p",r.KNIGHT="n",r.BISHOP="b",r.ROOK="r",r.QUEEN="q",r.KING="k",r.EMPTY=-1,r.SYMBOLS="pnbrqkPNBRQK",r.DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",r.POSSIBLE_RESULTS=["1-0","0-1","1/2-1/2","*"],r.PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},r.PIECE_OFFSETS={p:[],n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},r.ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],r.RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],r.SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5},r.FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},r.BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},r.RANK_1=7,r.RANK_2=6,r.RANK_3=5,r.RANK_4=4,r.RANK_5=3,r.RANK_6=2,r.RANK_7=1,r.RANK_8=0,r.RANKS=[r.RANK_8,r.RANK_7,r.RANK_6,r.RANK_5,r.RANK_4,r.RANK_3,r.RANK_2,r.RANK_1],r.SQUARES={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},r.ROOKS={w:[{square:r.SQUARES.a1,flag:r.BITS.QSIDE_CASTLE},{square:r.SQUARES.h1,flag:r.BITS.KSIDE_CASTLE}],b:[{square:r.SQUARES.a8,flag:r.BITS.QSIDE_CASTLE},{square:r.SQUARES.h8,flag:r.BITS.KSIDE_CASTLE}]}})(be)),be}var fe={},Ee;function ye(){if(Ee)return fe;Ee=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.State=void 0;var r=he(),e=Re(),t=(function(){function n(s,l,p,o,i,f,u){this.board=s||new Array(128),this.kings=l||{w:r.EMPTY,b:r.EMPTY},this.turn=p||r.WHITE,this.castling=o||{w:0,b:0},this.ep_square=i||r.EMPTY,this.half_moves=f||0,this.move_number=u||1}return n.prototype.clone=function(){return new n(this.board.slice(),{w:this.kings.w,b:this.kings.b},this.turn,{w:this.castling.w,b:this.castling.b},this.ep_square,this.half_moves,this.move_number)},Object.defineProperty(n.prototype,"fen",{get:function(){return e.getFen(this)},enumerable:!1,configurable:!0}),n})();return fe.State=t,fe}var O={},Pe;function _e(){if(Pe)return O;Pe=1,Object.defineProperty(O,"__esModule",{value:!0}),O.strippedSan=O.validateFen=O.isFlagKey=O.isSquare=O.isPieceSymbol=O.isColor=O.symbol=O.isDigit=O.swapColor=O.algebraic=O.file=O.rank=void 0;var r=he();function e(d){return d>>4}O.rank=e;function t(d){return d&15}O.file=t;function n(d){var _=t(d),C=e(d);return"abcdefgh".substring(_,_+1)+"87654321".substring(C,C+1)}O.algebraic=n;function s(d){return d===r.WHITE?r.BLACK:r.WHITE}O.swapColor=s;function l(d){return/^[0-9]$/.test(d)}O.isDigit=l;function p(d){var _=d.type,C=d.color;return C===r.WHITE?_.toUpperCase():_.toLowerCase()}O.symbol=p;function o(d){return d==="w"||d==="b"}O.isColor=o;function i(d){return/^[pnbrqk]$/.test(d)}O.isPieceSymbol=i;function f(d){return/^[a-h][1-8]$/.test(d)}O.isSquare=f;function u(d){var _=["NORMAL","CAPTURE","BIG_PAWN","EP_CAPTURE","PROMOTION","KSIDE_CASTLE","QSIDE_CASTLE"];return _.indexOf(d)!==-1}O.isFlagKey=u;function y(d){var _={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},C=d.split(/\s+/);if(C.length!==6)return{valid:!1,error_number:1,error:_[1]};if(isNaN(C[5])||parseInt(C[5],10)<=0)return{valid:!1,error_number:2,error:_[2]};if(isNaN(C[4])||parseInt(C[4],10)<0)return{valid:!1,error_number:3,error:_[3]};if(!/^(-|[abcdefgh][36])$/.test(C[3]))return{valid:!1,error_number:4,error:_[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(C[2]))return{valid:!1,error_number:5,error:_[5]};if(!/^(w|b)$/.test(C[1]))return{valid:!1,error_number:6,error:_[6]};var V=C[0].split("/");if(V.length!==8)return{valid:!1,error_number:7,error:_[7]};for(var B=0;B<V.length;B++){for(var U=0,W=!1,G=0;G<V[B].length;G++)if(isNaN(V[B][G])){if(!/^[prnbqkPRNBQK]$/.test(V[B][G]))return{valid:!1,error_number:9,error:_[9]};U+=1,W=!1}else{if(W)return{valid:!1,error_number:8,error:_[8]};U+=parseInt(V[B][G],10),W=!0}if(U!==8)return{valid:!1,error_number:10,error:_[10]}}return C[3][1]=="3"&&C[1]=="w"||C[3][1]=="6"&&C[1]=="b"?{valid:!1,error_number:11,error:_[11]}:{valid:!0,error_number:0,error:_[0]}}O.validateFen=y;function S(d){return d.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}return O.strippedSan=S,O}var Ce;function Re(){if(Ce)return E;Ce=1,Object.defineProperty(E,"__esModule",{value:!0}),E.validateMove=E.getBoard=E.ascii=E.buildMove=E.makeMove=E.insufficientMaterial=E.inStalemate=E.inCheckmate=E.inCheck=E.isKingAttacked=E.isAttacked=E.makePretty=E.sanToMove=E.moveToSan=E.generateMoves=E.removePiece=E.putPiece=E.clonePiece=E.cloneMove=E.getPiece=E.loadPgn=E.getPgn=E.loadFen=E.getFen=E.getDisambiguator=void 0;var r=he(),e=ye(),t=_e();function n(a,c,h){for(var v=d(a,{legal:!h}),m=c.from,A=c.to,b=c.piece,T=0,g=0,P=0,k=0,M=v.length;k<M;k++){var L=v[k].from,R=v[k].to,I=v[k].piece;b===I&&m!==L&&A===R&&(T++,t.rank(m)===t.rank(L)&&g++,t.file(m)===t.file(L)&&P++)}return T>0?g>0&&P>0?t.algebraic(m):P>0?t.algebraic(m).charAt(1):t.algebraic(m).charAt(0):""}E.getDisambiguator=n;function s(a){for(var c=0,h="",v=r.SQUARES.a8;v<=r.SQUARES.h1;v++){var m=a.board[v];if(!m)c++;else{c>0&&(h+=c,c=0);var A=m.color,b=m.type;h+=A===r.WHITE?b.toUpperCase():b.toLowerCase()}v+1&136&&(c>0&&(h+=c),v!==r.SQUARES.h1&&(h+="/"),c=0,v+=8)}var T="";a.castling[r.WHITE]&r.BITS.KSIDE_CASTLE&&(T+="K"),a.castling[r.WHITE]&r.BITS.QSIDE_CASTLE&&(T+="Q"),a.castling[r.BLACK]&r.BITS.KSIDE_CASTLE&&(T+="k"),a.castling[r.BLACK]&r.BITS.QSIDE_CASTLE&&(T+="q"),T=T||"-";var g=a.ep_square===r.EMPTY?"-":t.algebraic(a.ep_square);return[h,a.turn,T,g,a.half_moves,a.move_number].join(" ")}E.getFen=s;function l(a){var c=a.split(/\s+/),h=c[0],v=0;if(!t.validateFen(a).valid)return null;for(var m=new e.State,A=0;A<h.length;A++){var b=h.charAt(A);if(b==="/")v+=8;else if(t.isDigit(b))v+=parseInt(b,10);else{var T=b<"a"?r.WHITE:r.BLACK,g=y(m,{type:b.toLowerCase(),color:T},t.algebraic(v));if(!g)return null;m=g,v++}}return m.turn=c[1]===r.BLACK?r.BLACK:r.WHITE,c[2].indexOf("K")>-1&&(m.castling.w|=r.BITS.KSIDE_CASTLE),c[2].indexOf("Q")>-1&&(m.castling.w|=r.BITS.QSIDE_CASTLE),c[2].indexOf("k")>-1&&(m.castling.b|=r.BITS.KSIDE_CASTLE),c[2].indexOf("q")>-1&&(m.castling.b|=r.BITS.QSIDE_CASTLE),m.ep_square=c[3]==="-"?r.EMPTY:r.SQUARES[c[3]],m.half_moves=parseInt(c[4],10),m.move_number=parseInt(c[5],10),m}E.loadFen=l;function p(a,c,h,v,m){m===void 0&&(m={});var A=m.newline_char,b=A===void 0?`
`:A,T=m.max_width,g=T===void 0?0:T,P=[],k=!1;for(var M in c)P.push("["+M+' "'+c[M]+'"]'+b),k=!0;k&&v.length&&P.push(b);var L=function(F){var D=h[a.fen];if(typeof D<"u"){var q=F.length>0?" ":"";F=""+F+q+"{"+D+"}"}return F};v[0]&&(a=v[0].state);var R=[],I="";if(v.length===0&&R.push(L("")),v.forEach(function(F,D){var q=F.move;I=L(I),D===0&&q.color===r.BLACK?I=a.move_number+". ...":q.color===r.WHITE&&(I.length&&R.push(I),I=a.move_number+"."),I=I+" "+_(a,q),a=te(a,q)}),I.length&&R.push(L(I)),typeof c.Result<"u"&&R.push(c.Result),g===0)return P.join("")+R.join(" ");for(var w=function(){return P.length>0&&P[P.length-1]===" "?(P.pop(),!0):!1},H=function(F,D){for(var q=0,J=D.split(" ");q<J.length;q++){var z=J[q];if(z){if(F+z.length>g){for(;w();)F--;P.push(b),F=0}P.push(z),F+=z.length,P.push(" "),F++}}return w()&&F--,F},K=0,M=0;M<R.length;M++){if(K+R[M].length>g&&R[M].includes("{")){K=H(K,R[M]);continue}K+R[M].length>g&&M!==0?(P[P.length-1]===" "&&P.pop(),P.push(b),K=0):M!==0&&(P.push(" "),K++),P.push(R[M]),K+=R[M].length}return P.join("")}E.getPgn=p;function o(a,c){c===void 0&&(c={});var h=c.newline_char,v=h===void 0?`\r?
`:h,m=c.sloppy,A=m===void 0?!1:m,b=function(N){return N.replace(/\\/g,"\\")},T=function(N,Q){for(var ae=Q.newline_char,le={},ne=N.split(new RegExp(b(ae))),re="",ce="",ie=0;ie<ne.length;ie++)re=ne[ie].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),ce=ne[ie].replace(/^\[[A-Za-z]+\s"(.*)" *\]$/,"$1"),re.trim().length>0&&(le[re.trim()]=ce);return le},g=new RegExp("^(\\[((?:"+b(v)+")|.)*\\])(?:"+b(v)+"){2}"),P=g.test(a)?g.exec(a)[1]:"",k=l(r.DEFAULT_POSITION),M=T(P,{newline_char:v});if(M.SetUp==="1"&&"FEN"in M){var L=l(M.FEN);if(!L)return null;k=L}for(var R=function(N){return Array.from(N).map(function(Q){return Q.charCodeAt(0)<128?Q.charCodeAt(0).toString(16):encodeURIComponent(Q).replace(/%/g,"").toLowerCase()}).join("")},I=function(N){var Q;return N.length==0?"":decodeURIComponent("%"+((Q=N?.match(/.{1,2}/g))===null||Q===void 0?void 0:Q.join("%")))},w=function(N){return N=N.replace(new RegExp(b(v),"g")," "),"{"+R(N.slice(1,N.length-1))+"}"},H=function(N){if(N.startsWith("{")&&N.endsWith("}"))return I(N.slice(1,N.length-1))},K=a.replace(P,"").replace(new RegExp("({[^}]*})+?|;([^"+b(v)+"]*)","g"),function(N,Q,ae){return Q!==void 0?w(Q):" "+w("{"+ae.slice(1)+"}")}).replace(new RegExp(b(v),"g")," "),F=/(\([^()]+\))+?/g;F.test(K);)K=K.replace(F,"");K=K.replace(/\d+\.(\.\.)?/g,""),K=K.replace(/\.\.\./g,""),K=K.replace(/\$\d+/g,"");for(var D=K.trim().split(new RegExp(/\s+/)).join(",").replace(/,,+/g,",").split(","),q={},J=[],z=0;z<D.length;z++){var Z=D[z],j=H(Z);if(j!==void 0){q[k.fen]=j;continue}if(z===D.length-1&&r.POSSIBLE_RESULTS.indexOf(Z)!==-1){Object.keys(M).length&&typeof M.Result>"u"&&(M.Result=Z);continue}var X=C(k,D[z],{sloppy:A});if(X===null)return null;J.push({move:X,state:k});var L=te(k,X);if(!L)return null;k=L}return[k,M,q,J]}E.loadPgn=o;function i(a,c){if(!c||(c=c.toLowerCase(),!t.isSquare(c)))return null;var h=r.SQUARES[c],v=a.board[h];return v?u(v):null}E.getPiece=i;function f(a){return{to:a.to,from:a.from,color:a.color,flags:a.flags,piece:a.piece,captured:a.captured,promotion:a.promotion,san:a.san}}E.cloneMove=f;function u(a){return{color:a.color,type:a.type}}E.clonePiece=u;function y(a,c,h){var v=c.type,m=c.color;if(!v||!m||!h||(v=v.toLowerCase(),m=m.toLowerCase(),h=h.toLowerCase(),!t.isPieceSymbol(v)||!t.isColor(m)||!t.isSquare(h)))return null;var A=a.clone(),b=r.SQUARES[h];return v===r.KING&&A.kings[m]!==r.EMPTY&&A.kings[m]!==b?null:(A.board[b]={type:v,color:m},v===r.KING&&(A.kings[m]=b),A)}E.putPiece=y;function S(a,c){if(!c||(c=c.toLowerCase(),!t.isSquare(c)))return null;var h=r.SQUARES[c],v=a.board[h];if(!v)return null;var m=a.clone(),A=v.type,b=v.color;return A===r.KING&&(m.kings[b]=r.EMPTY),delete m.board[h],m}E.removePiece=S;function d(a,c){var h,v;c===void 0&&(c={});var m=c.legal,A=m===void 0?!0:m,b=function(ae,le,ne,re,ce){var ie=ae[ne];if(ie&&ie.type===r.PAWN&&(t.rank(re)===r.RANK_8||t.rank(re)===r.RANK_1))for(var Ae=[r.QUEEN,r.ROOK,r.BISHOP,r.KNIGHT],ge=0,Ne=Ae.length;ge<Ne;ge++)le.push(pe(a,ne,re,ce,Ae[ge]));else le.push(pe(a,ne,re,ce))},T=[],g=a.turn,P=t.swapColor(g),k={b:r.RANK_7,w:r.RANK_2},M=r.SQUARES.a8,L=r.SQUARES.h1,R=!1,I=c.square;if(I)if(I=I.toLowerCase(),t.isSquare(I))M=L=r.SQUARES[I],R=!0;else return[];for(var w=M;w<=L;w++){if(w&136){w+=7;continue}var H=a.board[w];if(!(!H||H.color!==g))if(H.type===r.PAWN){var K=w+r.PAWN_OFFSETS[g][0];if(!a.board[K]){b(a.board,T,w,K,r.BITS.NORMAL);var F=w+r.PAWN_OFFSETS[g][1];k[g]===t.rank(w)&&!a.board[F]&&b(a.board,T,w,F,r.BITS.BIG_PAWN)}for(var D=2;D<4;D++){var q=w+r.PAWN_OFFSETS[g][D];q&136||(a.board[q]&&((h=a.board[q])===null||h===void 0?void 0:h.color)===P?b(a.board,T,w,q,r.BITS.CAPTURE):q===a.ep_square&&b(a.board,T,w,a.ep_square,r.BITS.EP_CAPTURE))}}else for(var D=0,J=r.PIECE_OFFSETS[H.type].length;D<J;D++)for(var z=r.PIECE_OFFSETS[H.type][D],Z=w;Z+=z,!(Z&136);){if(!a.board[Z])b(a.board,T,w,Z,r.BITS.NORMAL);else{if(((v=a.board[Z])===null||v===void 0?void 0:v.color)===g)break;b(a.board,T,w,Z,r.BITS.CAPTURE);break}if(H.type==="n"||H.type==="k")break}}if(!R||L===a.kings[g]){if(a.castling[g]&r.BITS.KSIDE_CASTLE){var j=a.kings[g],X=j+2;!a.board[j+1]&&!a.board[X]&&!B(a,P,a.kings[g])&&!B(a,P,j+1)&&!B(a,P,X)&&b(a.board,T,a.kings[g],X,r.BITS.KSIDE_CASTLE)}if(a.castling[g]&r.BITS.QSIDE_CASTLE){var j=a.kings[g],X=j-2;!a.board[j-1]&&!a.board[j-2]&&!a.board[j-3]&&!B(a,P,a.kings[g])&&!B(a,P,j-1)&&!B(a,P,X)&&b(a.board,T,a.kings[g],X,r.BITS.QSIDE_CASTLE)}}if(!A)return T;for(var N=[],w=0,J=T.length;w<J;w++){var Q=te(a,T[w]);U(Q,g)||N.push(T[w])}return N}E.generateMoves=d;function _(a,c,h){var v;h===void 0&&(h={});var m=h.sloppy,A=m===void 0?!1:m,b=h.checkPromotion,T=b===void 0?!0:b,g="";if(c.flags&r.BITS.KSIDE_CASTLE)g="O-O";else if(c.flags&r.BITS.QSIDE_CASTLE)g="O-O-O";else{var P=n(a,c,A);c.piece!==r.PAWN&&(g+=c.piece.toUpperCase()+P),c.flags&(r.BITS.CAPTURE|r.BITS.EP_CAPTURE)&&(c.piece===r.PAWN&&(g+=t.algebraic(c.from)[0]),g+="x"),g+=t.algebraic(c.to),T&&c.flags&r.BITS.PROMOTION&&(g+="="+((v=c.promotion)===null||v===void 0?void 0:v.toUpperCase()))}var k=te(a,c);return W(k)&&(G(k)?g+="#":g+="+"),g}E.moveToSan=_;function C(a,c,h){h===void 0&&(h={});var v=h.sloppy,m=v===void 0?!1:v,A=h.checkPromotion,b=A===void 0?!0:A,T=t.strippedSan(c),g,P,k,M,L;m&&(g=T.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),g&&(P=g[1],k=g[2],M=g[3],L=g[4]));for(var R=d(a,{square:k}),I=0,w=R.length;I<w;I++){var H=_(a,R[I],{checkPromotion:b});if(T===t.strippedSan(H)||m&&T===t.strippedSan(_(a,R[I],h))||k&&M&&t.isSquare(k)&&t.isSquare(M)&&g&&(!P||P.toLowerCase()==R[I].piece)&&r.SQUARES[k]==R[I].from&&r.SQUARES[M]==R[I].to&&(!b||!L||L.toLowerCase()==R[I].promotion))return R[I]}return null}E.sanToMove=C;function V(a,c){var h=f(c),v="";for(var m in r.BITS)t.isFlagKey(m)&&r.BITS[m]&h.flags&&(v+=r.FLAGS[m]);return{to:t.algebraic(h.to),from:t.algebraic(h.from),color:h.color,flags:v,piece:h.piece,san:_(a,h),captured:h.captured,promotion:h.promotion}}E.makePretty=V;function B(a,c,h){for(var v,m=r.SQUARES.a8;m<=r.SQUARES.h1;m++){if(m&136){m+=7;continue}if(!(a.board[m]==null||((v=a.board[m])===null||v===void 0?void 0:v.color)!==c)){var A=a.board[m],b=m-h,T=b+119;if(A&&r.ATTACKS[T]&1<<r.SHIFTS[A.type]){if(A.type===r.PAWN){if(b>0){if(A.color===r.WHITE)return!0}else if(A.color===r.BLACK)return!0;continue}if(A.type==="n"||A.type==="k")return!0;for(var g=r.RAYS[T],P=m+g,k=!1;P!==h;){if(a.board[P]){k=!0;break}P+=g}if(!k)return!0}}}return!1}E.isAttacked=B;function U(a,c){return B(a,t.swapColor(c),a.kings[c])}E.isKingAttacked=U;function W(a){return U(a,a.turn)}E.inCheck=W;function G(a){return W(a)&&d(a).length===0}E.inCheckmate=G;function Y(a){return!W(a)&&d(a).length===0}E.inStalemate=Y;function ve(a){for(var c={},h=[],v=0,m=0,A=r.SQUARES.a8;A<=r.SQUARES.h1;A++){if(m=(m+1)%2,A&136){A+=7;continue}var b=a.board[A];b&&(c[b.type]=b.type in c?c[b.type]+1:1,b.type===r.BISHOP&&h.push(m),v++)}if(v===2)return!0;if(v===3&&(c[r.BISHOP]===1||c[r.KNIGHT]===1))return!0;if(v===c[r.BISHOP]+2){for(var T=0,g=h.length,A=0;A<g;A++)T+=h[A];if(T===0||T===g)return!0}return!1}E.insufficientMaterial=ve;function te(a,c){var h=a.clone(),v=h.turn,m=t.swapColor(v);h.board[c.to]=h.board[c.from],delete h.board[c.from],c.flags&r.BITS.EP_CAPTURE&&(h.turn===r.BLACK?delete h.board[c.to-16]:delete h.board[c.to+16]),c.flags&r.BITS.PROMOTION&&c.promotion&&t.isPieceSymbol(c.promotion)&&(h.board[c.to]={type:c.promotion,color:v});var A=h.board[c.to];if(A&&A.type===r.KING){if(h.kings[A.color]=c.to,c.flags&r.BITS.KSIDE_CASTLE){var b=c.to-1,T=c.to+1;h.board[b]=h.board[T],delete h.board[T]}else if(c.flags&r.BITS.QSIDE_CASTLE){var b=c.to+1,T=c.to-2;h.board[b]=h.board[T],delete h.board[T]}h.castling[v]=0}if(h.castling[v]){for(var g=0,P=r.ROOKS[v].length;g<P;g++)if(c.from===r.ROOKS[v][g].square&&h.castling[v]&r.ROOKS[v][g].flag){h.castling[v]^=r.ROOKS[v][g].flag;break}}if(h.castling[m]){for(var g=0,P=r.ROOKS[m].length;g<P;g++)if(c.to===r.ROOKS[m][g].square&&h.castling[m]&r.ROOKS[m][g].flag){h.castling[m]^=r.ROOKS[m][g].flag;break}}return c.flags&r.BITS.BIG_PAWN?h.turn==="b"?h.ep_square=c.to-16:h.ep_square=c.to+16:h.ep_square=r.EMPTY,c.piece===r.PAWN||c.flags&(r.BITS.CAPTURE|r.BITS.EP_CAPTURE)?h.half_moves=0:h.half_moves++,h.turn===r.BLACK&&h.move_number++,h.turn=t.swapColor(h.turn),h}E.makeMove=te;function pe(a,c,h,v,m){var A,b={color:a.turn,from:c,to:h,flags:v,piece:a.board[c].type};return m&&t.isPieceSymbol(m)&&(b.flags|=r.BITS.PROMOTION,b.promotion=m),a.board[h]?b.captured=(A=a.board[h])===null||A===void 0?void 0:A.type:v&r.BITS.EP_CAPTURE&&(b.captured=r.PAWN),b}E.buildMove=pe;function we(a,c){c===void 0&&(c=`
`);var h=r.RANKS.map(function(v){for(var m=a.slice(v*16,v*16+8),A=[],b=0,T=m;b<T.length;b++){var g=T[b];A.push(g?" "+t.symbol(g)+" ":" . ")}var P=A.join("");return"87654321"[v]+" |"+P+"|"});return["  +------------------------+",h.join(c),"  +------------------------+","    a  b  c  d  e  f  g  h"].join(c)}E.ascii=we;function Be(a){for(var c=[],h=[],v=r.SQUARES.a8;v<=r.SQUARES.h1;v++){var m=a[v];m==null?h.push(null):h.push({type:m.type,color:m.color}),v+1&136&&(c.push(h),h=[],v+=8)}return c}E.getBoard=Be;function Oe(a,c,h){h===void 0&&(h={});var v=h.checkPromotion,m=v===void 0?!0:v;if(typeof c=="string")return C(a,c,h);if(typeof c=="object")for(var A=d(a,{square:c.from}),b=0,T=A;b<T.length;b++){var g=T[b];if(c.from===t.algebraic(g.from)&&c.to===t.algebraic(g.to)&&(!m||!("promotion"in g)||c.promotion===g.promotion))return g}return null}return E.validateMove=Oe,E}var Me;function Le(){if(Me)return x;Me=1;var r=x&&x.__assign||function(){return r=Object.assign||function(o){for(var i,f=1,u=arguments.length;f<u;f++){i=arguments[f];for(var y in i)Object.prototype.hasOwnProperty.call(i,y)&&(o[y]=i[y])}return o},r.apply(this,arguments)},e=x&&x.__spreadArrays||function(){for(var o=0,i=0,f=arguments.length;i<f;i++)o+=arguments[i].length;for(var u=Array(o),y=0,i=0;i<f;i++)for(var S=arguments[i],d=0,_=S.length;d<_;d++,y++)u[y]=S[d];return u};Object.defineProperty(x,"__esModule",{value:!0}),x.Chess=void 0;var t=Re(),n=ye(),s=_e(),l=he(),p=(function(){function o(i){if(i===void 0&&(i=l.DEFAULT_POSITION),this._state=new n.State,this._history=[],this._header={},this._comments={},!this.load(i))throw new Error("Error loading fen")}return Object.defineProperty(o.prototype,"state",{get:function(){return this._state.clone()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"states",{get:function(){return e(this._history.map(function(i){return i.state.clone()}),[this.state])},enumerable:!1,configurable:!0}),o.prototype.load=function(i,f){f===void 0&&(f=!1);var u=t.loadFen(i);return u?(this._state=u,this._history=[],f||(this._header={}),this._comments={},this.updateSetup(),!0):!1},o.prototype.clear=function(i){i===void 0&&(i=!1),this._state=new n.State,this._history=[],i||(this._header={}),this._comments={},this.updateSetup()},o.prototype.reset=function(){this.load(l.DEFAULT_POSITION)},o.prototype.get=function(i){return t.getPiece(this._state,i)},o.prototype.put=function(i,f){var u=t.putPiece(this._state,i,f);return u?(this._state=u,this.updateSetup(),!0):!1},o.prototype.remove=function(i){var f=t.getPiece(this._state,i);if(!f)return null;var u=t.removePiece(this._state,i);return u?(this._state=u,f):null},o.prototype.moves=function(i){var f=this;i===void 0&&(i={});var u=i.square,y=i.verbose,S=y===void 0?!1:y,d=t.generateMoves(this._state,{square:u});return S?d.map(function(_){return t.makePretty(f._state,_)}):d.map(function(_){return t.moveToSan(f._state,_)})},o.prototype.fen=function(){return this._state.fen},o.prototype.inCheck=function(){return t.inCheck(this._state)},o.prototype.inCheckmate=function(){return t.inCheckmate(this._state)},o.prototype.inStalemate=function(){return t.inStalemate(this._state)},o.prototype.insufficientMaterial=function(){return t.insufficientMaterial(this._state)},o.prototype.inThreefoldRepetition=function(){for(var i={},f=function(d){var _=d.fen.split(" ").slice(0,4).join(" ");return i[_]=_ in i?i[_]+1:1,i[_]>=3},u=0,y=this._history;u<y.length;u++){var S=y[u].state;if(f(S))return!0}return f(this._state)},o.prototype.inDraw=function(){return this._state.half_moves>=100||this.inStalemate()||this.insufficientMaterial()||this.inThreefoldRepetition()},o.prototype.gameOver=function(){return this.inCheckmate()||this.inDraw()},o.prototype.board=function(){return t.getBoard(this._state.board)},o.prototype.pgn=function(i){return i===void 0&&(i={}),t.getPgn(this._state,this._header,this._comments,this._history,i)},o.prototype.loadPgn=function(i,f){f===void 0&&(f={});var u=t.loadPgn(i,f);if(!u)return!1;var y=u[0],S=u[1],d=u[2],_=u[3];return this._state=y,this._header=S,this._comments=d,this._history=_,!0},o.prototype.header=function(){return this._header},o.prototype.setHeader=function(i){this._header=i},o.prototype.addHeader=function(i,f){this._header[i]=f},o.prototype.removeHeader=function(i){delete this._header[i]},o.prototype.clearHeader=function(){this._header={}},o.prototype.ascii=function(i){return i===void 0&&(i=`
`),t.ascii(this._state.board,i)},o.prototype.turn=function(){return this._state.turn},o.prototype.move=function(i,f){f===void 0&&(f={});var u=t.validateMove(this._state,i,f);if(!u)return null;var y=t.makePretty(this._state,u);return f.dry_run||this.makeMove(u),y},o.prototype.validateMoves=function(i,f){f===void 0&&(f={});for(var u=[],y=this._state,S=0,d=i;S<d.length;S++){var _=d[S],C=t.validateMove(y,_,f);if(!C)return null;u.push(t.makePretty(y,C)),y=t.makeMove(y,C)}return u},o.prototype.isPromotion=function(i,f){f===void 0&&(f={});var u=t.validateMove(this._state,i,r(r({},f),{checkPromotion:!1}));return u?!!(u.flags&l.BITS.PROMOTION):!1},o.prototype.undo=function(){var i=this.undoMove();return i?t.makePretty(this._state,i):null},o.prototype.squareColor=function(i){if(s.isSquare(i)){var f=l.SQUARES[i];return(s.rank(f)+s.file(f))%2===0?"light":"dark"}return null},o.prototype.history=function(i){i===void 0&&(i={});var f=i.verbose,u=f===void 0?!1:f;if(!this._history.length)return[];var y;return u?this._history.map(function(S){var d=S.move;return y=S.state,t.makePretty(y,d)}):this._history.map(function(S){var d=S.move;return y=S.state,t.moveToSan(y,d)})},o.prototype.getComment=function(i){return i=i||this.fen(),this._comments[i]},o.prototype.getComments=function(){var i=this;return this.pruneComments(),Object.keys(this._comments).map(function(f){return{fen:f,comment:i._comments[f]}})},o.prototype.setComment=function(i,f){f=f||this.fen(),this._comments[f]=i.replace("{","[").replace("}","]")},o.prototype.deleteComment=function(i){i=i||this.fen();var f=this._comments[i];return delete this._comments[i],f},o.prototype.deleteComments=function(){var i=this;return this.pruneComments(),Object.keys(this._comments).map(function(f){var u=i._comments[f];return delete i._comments[f],{fen:f,comment:u}})},o.prototype.validateFen=function(i){return s.validateFen(i)},o.prototype.clone=function(){var i=new o;return i._state=this._state,i._history=e(this._history),i._header=r({},this._header),i._comments=r({},this._comments),i},o.prototype.perft=function(i){for(var f=t.generateMoves(this._state,{legal:!1}),u=0,y=this._state.turn,S=0,d=f.length;S<d;S++){if(this.makeMove(f[S]),!this.kingAttacked(y))if(i-1>0){var _=this.perft(i-1);u+=_}else u++;this.undoMove()}return u},o.prototype.updateSetup=function(){var i=this._state.fen;this._history.length>0||(i!==l.DEFAULT_POSITION?(this._header.SetUp="1",this._header.FEN=i):(delete this._header.SetUp,delete this._header.FEN))},o.prototype.pruneComments=function(){var i=this,f={},u=function(S){S in i._comments&&(f[S]=i._comments[S])};this._history.forEach(function(S){var d=S.state;y=d,u(y.fen)});var y=this._state;u(y.fen),this._comments=f},o.prototype.strippedSan=function(i){return i.replace(/=/,"").replace(/[+#]?[?!]*$/,"")},o.prototype.attacked=function(i,f){return t.isAttacked(this._state,i,f)},o.prototype.kingAttacked=function(i){return this.attacked(s.swapColor(i),this._state.kings[i])},o.prototype.makeMove=function(i){this._history.push({move:i,state:this._state}),this._state=t.makeMove(this._state,i)},o.prototype.undoMove=function(){var i=this._history.pop();return i==null?null:(this._state=i.state,i.move)},o})();return x.Chess=p,x}var Ie;function Ke(){return Ie||(Ie=1,(function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=Le();Object.defineProperty(r,"Chess",{enumerable:!0,get:function(){return e.Chess}});var t=ye();Object.defineProperty(r,"State",{enumerable:!0,get:function(){return t.State}});var n=he();Object.defineProperty(r,"WHITE",{enumerable:!0,get:function(){return n.WHITE}}),Object.defineProperty(r,"BLACK",{enumerable:!0,get:function(){return n.BLACK}}),Object.defineProperty(r,"PAWN",{enumerable:!0,get:function(){return n.PAWN}}),Object.defineProperty(r,"KNIGHT",{enumerable:!0,get:function(){return n.KNIGHT}}),Object.defineProperty(r,"BISHOP",{enumerable:!0,get:function(){return n.BISHOP}}),Object.defineProperty(r,"ROOK",{enumerable:!0,get:function(){return n.ROOK}}),Object.defineProperty(r,"QUEEN",{enumerable:!0,get:function(){return n.QUEEN}}),Object.defineProperty(r,"KING",{enumerable:!0,get:function(){return n.KING}}),Object.defineProperty(r,"EMPTY",{enumerable:!0,get:function(){return n.EMPTY}}),Object.defineProperty(r,"SQUARES",{enumerable:!0,get:function(){return n.SQUARES}}),Object.defineProperty(r,"FLAGS",{enumerable:!0,get:function(){return n.FLAGS}}),Object.defineProperty(r,"BITS",{enumerable:!0,get:function(){return n.BITS}});var s=_e();Object.defineProperty(r,"rank",{enumerable:!0,get:function(){return s.rank}}),Object.defineProperty(r,"file",{enumerable:!0,get:function(){return s.file}}),Object.defineProperty(r,"algebraic",{enumerable:!0,get:function(){return s.algebraic}})})(Se)),Se}var se=Ke();const Fe="3.1.1";class ${constructor(e,t){this._currentBannedMove=null,this._history=[],this._ply=1,this._indicatorConfig={pgn:!0,serialization:!0,san:!0},this.chess=new se.Chess,t?this.loadFromPGN(t):e&&this.loadFromFEN(e)}getPly(){return this._ply}getActivePlayer(){switch((this._ply-1)%4+1){case 1:return"black";case 2:return"white";case 3:return"white";case 4:return"black";default:return"black"}}getActionType(){return this._ply%2===1?"ban":"move"}get turn(){return this.getActivePlayer()}get currentBannedMove(){return this._currentBannedMove}nextActionType(){return this.getActionType()}play(e){try{return"ban"in e?this.playBan(e.ban):this.playMove(e.move)}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}playBan(e){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.getActionType()!=="ban")return{success:!1,error:"Expected a move, not a ban"};if(!this.legalBans().some(d=>d.from===e.from&&d.to===e.to))return{success:!1,error:`Invalid ban: ${e.from}-${e.to}`};this._currentBannedMove=e;const s=new se.Chess(this.chess.fen()),p=s.moves({verbose:!0}).filter(d=>!(d.from===e.from&&d.to===e.to)),o=p.length===0&&s.inCheck(),i=p.length===0&&!s.inCheck(),f=s.inCheck()&&p.length>0,u={check:f,checkmate:o,stalemate:i,gameOver:o||i,banCausedCheckmate:o,banCausedStalemate:i};let y=`${e.from}${e.to}`;this._indicatorConfig.san&&(o?y+="#":i?y+="=":f&&(y+="+"));const S={ply:this._ply,player:this.getActivePlayer(),actionType:"ban",action:e,fen:this.fen(),bannedMove:e,san:y,flags:u};return this._history.push(S),this._ply++,{success:!0,action:{ban:e},san:this._indicatorConfig.san?y:`${e.from}${e.to}`,newFen:this.fen(),flags:u,check:u.check,checkmate:u.checkmate,stalemate:u.stalemate,gameOver:u.gameOver,draw:u.draw}}playMove(e){if(this.gameOver())return{success:!1,error:"Game is over"};if(this.getActionType()!=="move")return{success:!1,error:"Expected a ban, not a move"};if(this.isBannedMove(e))return{success:!1,error:`Move ${e.from}-${e.to} is banned`};const t=this.chess.move({from:e.from,to:e.to,promotion:e.promotion});if(!t)return{success:!1,error:`Invalid move: ${e.from}-${e.to}`};const n={check:this.chess.inCheck(),checkmate:this.chess.inCheckmate(),stalemate:this.chess.inStalemate(),draw:this.chess.inDraw(),gameOver:this.chess.gameOver(),insufficientMaterial:this.chess.insufficientMaterial(),threefoldRepetition:this.chess.inThreefoldRepetition(),fiftyMoveRule:this.chess.inDraw()&&!this.chess.inStalemate()&&!this.chess.insufficientMaterial()},s={ply:this._ply,player:this.getActivePlayer(),actionType:"move",action:e,san:t.san,fen:this.fen(),bannedMove:this._currentBannedMove,flags:n};this._history.push(s),this._currentBannedMove=null,this._ply++;let l=t.san;return!this._indicatorConfig.san&&l&&(l=l.replace(/[+#=]$/,"")),{success:!0,action:{move:e},san:l,newFen:this.fen(),flags:n,check:n.check,checkmate:n.checkmate,stalemate:n.stalemate,gameOver:n.gameOver,draw:n.draw}}isBannedMove(e){return this._currentBannedMove?this._currentBannedMove.from===e.from&&this._currentBannedMove.to===e.to:!1}getLegalActions(){return this.gameOver()?[]:this.getActionType()==="ban"?this.legalBans().map(e=>({ban:e})):this.legalMoves().map(e=>({move:e}))}legalMoves(){if(this.gameOver())return[];if(this.getActionType()!=="move")return[];const t=this.chess.moves({verbose:!0}).map(n=>({from:n.from,to:n.to,promotion:n.promotion}));return this._currentBannedMove?t.filter(n=>!this.isBannedMove(n)):t}legalBans(){if(this.gameOver())return[];if(this.getActionType()!=="ban")return[];const t=new se.Chess(this.chess.fen()).moves({verbose:!0}),n=new Map;return t.forEach(s=>{const l=`${s.from}-${s.to}`;n.has(l)||n.set(l,{from:s.from,to:s.to})}),Array.from(n.values())}inCheck(){return this.chess.inCheck()}inCheckmate(){return this.chess.inCheckmate()}inStalemate(){return this.chess.inStalemate()}gameOver(){return this.inCheckmate()||this.inStalemate()||this.inDraw()}inDraw(){return this.chess.inDraw()}inThreefoldRepetition(){return this.chess.inThreefoldRepetition()}insufficientMaterial(){return this.chess.insufficientMaterial()}currentPlayer(){return this.turn}setIndicatorConfig(e){this._indicatorConfig={...this._indicatorConfig,...e}}getIndicatorConfig(){return{...this._indicatorConfig}}nextMoveColor(){return this.chess.turn()==="w"?"white":"black"}getGameIndicator(){const e=this.getGameFlags();return e.checkmate?"#":e.stalemate||e.draw?"=":e.check?"+":""}getGameFlags(){const e=this._history[this._history.length-1],t=e?.flags?.banCausedCheckmate||!1,n=e?.flags?.banCausedStalemate||!1;return{check:this.chess.inCheck(),checkmate:this.chess.inCheckmate(),stalemate:this.chess.inStalemate(),draw:this.chess.inDraw(),gameOver:this.chess.gameOver(),insufficientMaterial:this.chess.insufficientMaterial(),threefoldRepetition:this.chess.inThreefoldRepetition(),fiftyMoveRule:this.chess.inDraw()&&!this.chess.inStalemate()&&!this.chess.insufficientMaterial()&&!this.chess.inThreefoldRepetition(),banCausedCheckmate:t,banCausedStalemate:n}}fen(){const e=this.chess.fen();let t=this._ply.toString();this._currentBannedMove&&(t+=`:${this._currentBannedMove.from}${this._currentBannedMove.to}`);const n=this.getGameIndicator();return t+=n,`${e} ${t}`}pgn(){let e="",t="";for(let n=0;n<this._history.length;n++){const s=this._history[n];let l=1;if(s.actionType==="move"&&(s.player==="white"?l=Math.floor((s.ply-2)/4)+1:l=Math.floor((s.ply-4)/4)+1),s.actionType==="ban"){const p=s.action;let o=`${p.from}${p.to}`;if(this._indicatorConfig.pgn&&s.san){const i=s.san.match(/[+#=]$/)?.[0];i&&(o+=i)}t+=`{banning: ${o}} `}else{s.player==="white"&&(t=`${l}. ${t}`);let p=s.san||"";!this._indicatorConfig.pgn&&p&&(p=p.replace(/[+#=]$/,"")),t+=`${p} `,s.player==="black"&&(e+=t,t="")}}if(t){const n=this._history.length>0?Math.floor((this._history[this._history.length-1].ply+1)/2):1;t.startsWith(`${n}.`)||(t=`${n}. ${t}`),e+=t}if(this._history.length>0){const n=this._history[this._history.length-1];if(n.actionType==="move"&&n.san){if(n.san.endsWith("#")){const s=n.player==="white"?"1-0":"0-1";e=e.trim()+" "+s}}else if(n.actionType==="ban"&&this.gameOver())if(this.inCheckmate()){const s=this.chess.turn()==="w"?"0-1":"1-0";e=e.trim()+" "+s}else this.inStalemate()&&(e=e.trim()+" 1/2-1/2")}return e.trim()}history(){return[...this._history]}reset(){this.chess=new se.Chess,this._currentBannedMove=null,this._history=[],this._ply=1}ascii(){let e=this.chess.ascii();return this._currentBannedMove&&(e+=`
Banned: ${this._currentBannedMove.from}-${this._currentBannedMove.to}`),e+=`
Ply: ${this._ply} (${this.getActionType()} by ${this.getActivePlayer()})`,e}static serializeAction(e,t){let n;if("ban"in e)n=`b:${e.ban.from}${e.ban.to}`;else{const s=e.move;n=`m:${s.from}${s.to}${s.promotion||""}`}return t&&(n+=t),n}static deserializeAction(e){const t=e.match(/^([bm]):([a-h][1-8])([a-h][1-8])([qrbn])?([+#=])?$/);if(!t)throw new Error(`Invalid serialized action format: ${e}`);const[,n,s,l,p,o]=t;return n==="b"?{ban:{from:s,to:l}}:{move:p?{from:s,to:l,promotion:p}:{from:s,to:l}}}getLastActionSerialized(){if(this._history.length===0)return null;const e=this._history[this._history.length-1],t=e.actionType==="ban"?{ban:e.action}:{move:e.action};if(!this._indicatorConfig.serialization)return $.serializeAction(t);let n;if(e.san){const s=e.san.match(/[+#=]$/);s&&(n=s[0])}return $.serializeAction(t,n)}getSyncState(){return{fen:this.fen(),lastAction:this.getLastActionSerialized()||void 0,ply:this._ply}}playSerializedAction(e){try{const t=$.deserializeAction(e);return this.play(t)}catch(t){return{success:!1,error:t instanceof Error?t.message:"Invalid serialized action"}}}loadFromSyncState(e){this.loadFromFEN(e.fen),this._ply=e.ply}getActionLog(){return this._history.map(e=>{if(e.actionType==="ban"){const t=e.action;let n=`b:${t.from}${t.to}`;if(e.san&&this._indicatorConfig.serialization){const s=e.san.match(/[+#=]$/);s&&(n+=s[0])}return n}else return e.san||`${e.action.from}${e.action.to}`})}getActionHistory(){return this._history.map((e,t)=>{const n=e.actionType==="ban"?{ban:e.action}:{move:e.action};if(!this._indicatorConfig.serialization)return $.serializeAction(n);let s;return e.actionType==="move"?e.san?.endsWith("#")?s="#":e.san?.endsWith("+")&&(s="+"):t===this._history.length-1&&(this.gameOver()?this.inCheckmate()?s="#":this.inStalemate()&&(s="="):this.nextActionType()==="move"&&this.chess.inCheck()&&(s="+")),$.serializeAction(n,s)})}static replayFromActions(e,t){const n=new $(t);for(const s of e){const l=n.playSerializedAction(s);if(!l.success)throw new Error(`Failed to replay action ${s}: ${l.error}`)}return n}loadFromFEN(e){const t=e.split(" ");if(t.length<7){this.chess=new se.Chess(e);return}const n=t.slice(0,6).join(" ");let s=t[6];if(this.chess=new se.Chess(n),s&&s!=="-"){const l=s[s.length-1];if((l==="+"||l==="#"||l==="=")&&(s=s.slice(0,-1)),s.includes(":")){const[p,o]=s.split(":");this._ply=parseInt(p,10)||1,o&&o.length>=4&&(this._currentBannedMove={from:o.substring(0,2),to:o.substring(2,4)})}else{const p=parseInt(s,10);if(!isNaN(p))this._ply=p;else if(s.startsWith("b:")||s.startsWith("w:")){const[o,i]=s.split(":");i!=="ban"&&i.length===4&&(this._currentBannedMove={from:i.substring(0,2),to:i.substring(2,4)})}}}}loadFromPGN(e){this.reset();const t=e.match(/\{banning:\s*[a-h][1-8][a-h][1-8]\}|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](?:=[QRBN])?[+#]?|\d+\./g);if(t){for(const n of t)if(!/^\d+\.$/.test(n)){if(n.includes("banning:")){const s=n.match(/([a-h][1-8])([a-h][1-8])/);if(s){const l={from:s[1],to:s[2]};this.play({ban:l})}}else if(/^[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8]/.test(n)){const l=this.legalMoves().find(p=>{const i=new se.Chess(this.chess.fen()).move({from:p.from,to:p.to,promotion:p.promotion});return i&&i.san===n});l&&this.play({move:l})}}}}}$.VERSION=Fe;class ee{constructor(e={}){this.nodesEvaluated=0,this.config={maxDepth:e.maxDepth??6,timeLimit:e.timeLimit??5e3,useTranspositionTable:e.useTranspositionTable??!0,evaluationWeights:{material:e.evaluationWeights?.material??1,position:e.evaluationWeights?.position??.3,banPotential:e.evaluationWeights?.banPotential??.4,mobility:e.evaluationWeights?.mobility??.2}},this.transpositionTable=new Map}findBestAction(e,t){const n=Date.now(),s=t??this.config.timeLimit;this.nodesEvaluated=0;let l=null,p=-1/0;this.config.useTranspositionTable&&this.transpositionTable.clear();for(let o=1;o<=this.config.maxDepth&&!(Date.now()-n>s*.9);o++){const i=this.minimax(e,o,-1/0,1/0,!0);if(i.action&&(l=i.action,p=i.score),Math.abs(p)>9e3||o>4&&Date.now()-n>s*.5)break}if(!l){const o=e.getLegalActions();if(o.length>0)l=o[0];else throw new Error("No legal actions available")}return l}minimax(e,t,n,s,l){this.nodesEvaluated++;const p=this.getPositionHash(e);if(this.config.useTranspositionTable){const S=this.transpositionTable.get(p);if(S&&S.depth>=t){if(S.flag==="exact")return{score:S.score,action:S.action};if(S.flag==="lower"&&S.score>n?n=S.score:S.flag==="upper"&&S.score<s&&(s=S.score),n>=s)return{score:S.score,action:S.action}}}if(t===0||e.gameOver()){const S=this.evaluatePosition(e);return{score:l?S:-S,action:null}}const o=e.getLegalActions();if(o.length===0){const S=this.evaluatePosition(e);return{score:l?S:-S,action:null}}const i=this.orderActions(e,o);let f=null,u=l?-1/0:1/0,y="exact";for(const S of i){const d=this.cloneGame(e),_=d.play(S);if(!_.success)continue;if(_.flags?.banCausedCheckmate||_.flags?.checkmate){const W=l?1e4-(10-t):-1e4+(10-t);if((l&&W>u||!l&&W<u)&&(u=W,f=S),l?n=Math.max(n,u):s=Math.min(s,u),n>=s)break;continue}const C=d.getActivePlayer(),V=e.getActivePlayer(),B=C!==V,U=this.minimax(d,t-1,n,s,B?!l:l);if(l?(U.score>u&&(u=U.score,f=S),n=Math.max(n,u)):(U.score<u&&(u=U.score,f=S),s=Math.min(s,u)),s<=n){y=l?"lower":"upper";break}}return this.config.useTranspositionTable&&this.transpositionTable.set(p,{score:u,depth:t,action:f,flag:y}),{score:u,action:f}}evaluatePosition(e){if(e.history()[e.history().length-1]?.flags?.banCausedCheckmate||e.inCheckmate())return-1e4;if(e.inStalemate()||e.inDraw())return 0;const n=this.getMaterialScore(e),s=this.getPositionalScore(e),l=this.getMobilityScore(e),p=e.getActionType();let o=0;p==="ban"?o=this.evaluateBanPotential(e):e.currentBannedMove&&(o=-this.evaluateBannedMoveImpact(e));const i=this.config.evaluationWeights,f=n*i.material+s*i.position+l*i.mobility+o*i.banPotential;return e.getActivePlayer()==="white"?f:-f}getMaterialScore(e){const n=e.fen().split(" ")[0];let s=0;for(const l of n)if(l in ee.PIECE_VALUES){const p=ee.PIECE_VALUES[l.toLowerCase()];s+=l===l.toUpperCase()?p:-p}return s}getPositionalScore(e){const n=e.fen().split(" ")[0];let s=0,l=0,p=0;for(const o of n)if(o==="/")l++,p=0;else if("12345678".includes(o))p+=parseInt(o);else{const i=o.toLowerCase(),f=o===o.toUpperCase(),u=f?l*8+p:(7-l)*8+p;let y=0;i==="p"?y=ee.PAWN_TABLE[u]:i==="n"&&(y=ee.KNIGHT_TABLE[u]),s+=f?y:-y,p++}return s}getMobilityScore(e){return e.getLegalActions().length*10}evaluateBanPotential(e){const t=e.legalBans();let n=0;for(const s of t)this.preventsKnightDevelopment(s)&&(n+=30),this.preventsCenterControl(s)&&(n+=40),this.preventsCastling(e,s)&&(n+=50),this.isOnlyEscape(e,s)&&(n+=1e4);return n}evaluateBannedMoveImpact(e){const t=e.currentBannedMove;if(!t)return 0;let n=10;return["e4","e5","d4","d5"].includes(t.to)&&(n+=20),(t.from[1]==="1"||t.from[1]==="8")&&(n+=15),n}preventsKnightDevelopment(e){return[{from:"b1",to:"c3"},{from:"b1",to:"a3"},{from:"g1",to:"f3"},{from:"g1",to:"h3"},{from:"b8",to:"c6"},{from:"b8",to:"a6"},{from:"g8",to:"f6"},{from:"g8",to:"h6"}].some(n=>n.from===e.from&&n.to===e.to)}preventsCenterControl(e){return["e4","e5","d4","d5"].includes(e.to)}preventsCastling(e,t){return[{from:"e1",to:"g1"},{from:"e1",to:"c1"},{from:"e8",to:"g8"},{from:"e8",to:"c8"}].some(s=>s.from===t.from&&s.to===t.to)}isOnlyEscape(e,t){const n=this.cloneGame(e);if(!n.inCheck())return!1;const s=n.legalMoves();if(s.length===1){const l=s[0];return l.from===t.from&&l.to===t.to}return!1}orderActions(e,t){return t.sort((n,s)=>{const l=this.getActionPriority(e,n);return this.getActionPriority(e,s)-l})}getActionPriority(e,t){let n=0;if("move"in t){const s=t.move,l=this.cloneGame(e),p=this.getMaterialScore(l);l.play(t);const o=this.getMaterialScore(l);Math.abs(o-p)>0&&(n+=100),["e4","e5","d4","d5"].includes(s.to)&&(n+=50),(s.from[1]==="1"||s.from[1]==="8")&&(n+=30),l.inCheck()&&(n+=80)}else if("ban"in t){const s=t.ban;["e4","e5","d4","d5"].includes(s.to)&&(n+=40),this.preventsKnightDevelopment(s)&&(n+=30)}return n}cloneGame(e){return new $(e.fen())}getPositionHash(e){return e.fen()}getStatistics(){return{nodesEvaluated:this.nodesEvaluated,transpositionTableSize:this.transpositionTable.size}}}ee.PIECE_VALUES={p:100,n:320,b:330,r:500,q:900,k:2e4};ee.PAWN_TABLE=[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,0,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0];ee.KNIGHT_TABLE=[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,20,20,15,5,-30,-30,0,15,20,20,15,0,-30,-30,5,10,15,15,10,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50];class Ue{constructor(e={}){this.nodes=0,this.qnodes=0,this.maxPly=0,this.searchStartTime=0,this.searchTimeLimit=0,this.stopSearch=!1,this.killerMoves={},this.historyTable={},this.pvTable={},this.pvLength=new Array(128).fill(0),this.ttAge=0,this.zobristPieces=[],this.zobristCastling=[],this.zobristEnPassant=[],this.zobristSide=BigInt(0),this.zobristBan=new Map,this.PIECE_VALUES={p:100,n:320,b:330,r:500,q:900,k:2e4},this.PST={p:[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,0,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0],n:[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,20,20,15,5,-30,-30,0,15,20,20,15,0,-30,-30,5,10,15,15,10,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],b:[-20,-10,-10,-10,-10,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,10,10,5,0,-10,-10,5,5,10,10,5,5,-10,-10,0,10,10,10,10,0,-10,-10,10,10,10,10,10,10,-10,-10,5,0,0,0,0,5,-10,-20,-10,-10,-10,-10,-10,-10,-20],r:[0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,0,0,0,5,5,0,0,0],q:[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,0,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],k:[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20],k_endgame:[-50,-40,-30,-20,-20,-30,-40,-50,-30,-20,-10,0,0,-10,-20,-30,-30,-10,20,30,30,20,-10,-30,-30,-10,30,40,40,30,-10,-30,-30,-10,30,40,40,30,-10,-30,-30,-10,20,30,30,20,-10,-30,-30,-30,0,0,0,0,-30,-30,-50,-30,-30,-30,-30,-30,-30,-50]},this.BAN_WEIGHTS={centerControl:40,development:30,castlingRights:50,onlyEscape:1e4,forcingMove:25,pieceActivity:20,pawnStructure:15},this.config={threads:e.threads??1,hash:e.hash??128,multiPV:e.multiPV??1,contempt:e.contempt??0,analysisMode:e.analysisMode??!1,skillLevel:e.skillLevel??20,moveTime:e.moveTime??5e3,timeControl:e.timeControl??{}},this.ttSize=this.config.hash*1024*1024/64,this.ttTable=new Map,this.initializeZobrist()}initializeZobrist(){this.zobristPieces=[];const e=["P","N","B","R","Q","K","p","n","b","r","q","k"];for(let t=0;t<e.length;t++){this.zobristPieces[t]=[];for(let n=0;n<64;n++)this.zobristPieces[t][n]=BigInt(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))}this.zobristCastling=[];for(let t=0;t<16;t++)this.zobristCastling[t]=BigInt(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER));this.zobristEnPassant=[];for(let t=0;t<8;t++)this.zobristEnPassant[t]=BigInt(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER));this.zobristSide=BigInt(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),this.zobristBan=new Map}search(e,t={}){this.nodes=0,this.qnodes=0,this.maxPly=0,this.stopSearch=!1,this.searchStartTime=Date.now(),this.ttAge++,this.killerMoves={},this.pvTable={},this.pvLength=new Array(128).fill(0),t.movetime?this.searchTimeLimit=t.movetime:this.config.timeControl?.wtime||this.config.timeControl?.btime?this.searchTimeLimit=this.calculateTimeForMove(e):this.searchTimeLimit=this.config.moveTime||5e3;let n=null,s=-1/0,l=1;const p=t.depth||64;let o=-1/0,i=1/0,f=50;for(;l<=p&&!this.stopSearch&&!(!t.infinite&&this.shouldStopSearch());){let u,y=!0,S=0;for(;y&&S<5;){S++;const d=this.alphaBeta(e,l,0,o,i);u=d.score,u<=o?(i=(o+i)/2,o=Math.max(u-f,-1/0),f*=2):u>=i?(o=(o+i)/2,i=Math.min(u+f,1/0),f*=2):(y=!1,s=u,d.action&&(n=d.action),f=50,o=u-f,i=u+f)}if(this.pvTable[0]&&console.log(`info depth ${l} score cp ${s} nodes ${this.nodes} nps ${this.getNPS()} pv ${this.getPVString()}`),Math.abs(s)>9e3)break;l++}if(!n){const u=e.getLegalActions();u.length>0&&(n=u[0])}return{nodes:this.nodes,qnodes:this.qnodes,tbhits:0,depth:l-1,seldepth:this.maxPly,time:Date.now()-this.searchStartTime,nps:this.getNPS(),hashfull:this.getHashFull(),pv:this.pvTable[0]||[]}}getBestMove(e){return this.search(e).pv[0]||null}alphaBeta(e,t,n,s,l,p=!0){if(n>this.maxPly&&(this.maxPly=n),this.stopSearch)return{score:0,action:null};if(this.nodes++,this.pvLength[n]=n,e.gameOver())return e.inCheckmate()?{score:-1e4+n,action:null}:{score:0,action:null};const o=this.probeTT(e),i=o?.move||null;if(o&&o.depth>=t&&!p){if(o.bound==="exact")return{score:o.score,action:i};if(o.bound==="lower"&&o.score>=l)return{score:o.score,action:i};if(o.bound==="upper"&&o.score<=s)return{score:o.score,action:i}}if(t<=0)return this.quiescence(e,n,s,l);!p&&t>=3&&!e.inCheck()&&e.getActionType();const f=this.generateOrderedActions(e,n,i);if(f.length===0)return{score:this.evaluate(e),action:null};let u=-1/0,y=null,S="upper";for(let d=0;d<f.length;d++){const _=f[d].action,C=new $(e.fen());if(!C.play(_).success)continue;let B;if(d===0){const U=C.getActivePlayer(),W=e.getActivePlayer(),G=U===W,Y=this.alphaBeta(C,t-1,n+1,G?s:-l,G?l:-s,p).score;B=G?Y:-Y}else{let U=0;t>=3&&d>=4&&!e.inCheck()&&(U=Math.floor(Math.sqrt(t-1)+Math.sqrt(d)),U=Math.min(U,t-2));const W=C.getActivePlayer(),G=e.getActivePlayer(),Y=W===G,ve=this.alphaBeta(C,t-1-U,n+1,Y?s:-s-1,Y?l:-s,!1).score;if(B=Y?ve:-ve,B>s&&B<l){const te=this.alphaBeta(C,t-1,n+1,Y?s:-l,Y?l:-s,p).score;B=Y?te:-te}}if(B>u&&(u=B,y=_,B>s&&this.updatePV(n,_)),B>s&&(s=B,S="exact",this.isCapture(e,_)||(this.updateHistory(_,t),this.updateKillers(n,_))),s>=l){S="lower",this.isCapture(e,_)||this.updateKillers(n,_);break}}return this.storeTT(e,t,u,S,y),{score:u,action:y}}quiescence(e,t,n,s){this.qnodes++;const l=this.evaluate(e);if(l>=s)return{score:s,action:null};n<l&&(n=l);const p=this.generateOrderedActions(e,t,null,!0);let o=l,i=null;for(const f of p){const u=f.action;if(!this.isForcingAction(e,u))continue;const y=new $(e.fen());if(!y.play(u).success)continue;const d=-this.quiescence(y,t+1,-s,-n).score;if(d>o&&(o=d,i=u),d>n&&(n=d),n>=s)break}return{score:o,action:i}}evaluate(e){if(e.inCheckmate())return-1e4;if(e.inStalemate()||e.inDraw())return 0;const t=e.getActivePlayer();let n=0;return n+=this.getMaterialBalance(e),n+=this.getPieceSquareScore(e),n+=this.getMobilityScore(e),n+=this.getKingSafety(e),n+=this.getPawnStructure(e),e.getActionType()==="ban"?n+=this.getBanPotentialScore(e):e.currentBannedMove&&(n-=this.getBannedMoveImpact(e)),t==="white"?n:-n}getMaterialBalance(e){const n=e.fen().split(" ")[0];let s=0;for(const l of n){const p=l.toLowerCase();if(p in this.PIECE_VALUES){const o=this.PIECE_VALUES[p];s+=l===l.toUpperCase()?o:-o}}return s}getPieceSquareScore(e){const n=e.fen().split(" ")[0];let s=0,l=0,p=0;for(const o of n)if(o==="/")l++,p=0;else if("12345678".includes(o))p+=parseInt(o);else{const i=o.toLowerCase(),f=o===o.toUpperCase(),u=l*8+p,y=(7-l)*8+p,S=f?u:y;if(i in this.PST){const d=this.PST[i],_=Array.isArray(d)?d[S]:0;s+=f?_:-_}p++}return s}getMobilityScore(e){return e.getLegalActions().length*10}getKingSafety(e){let t=0;return e.inCheck()&&(t-=50),t}getPawnStructure(e){return 0}getBanPotentialScore(e){const t=e.legalBans();let n=0;for(const s of t){let l=0;if(new $(e.fen()).play({ban:s}).flags?.banCausedCheckmate)return this.BAN_WEIGHTS.onlyEscape;this.blocksCenterControl(s)&&(l+=this.BAN_WEIGHTS.centerControl),this.blocksDevelopment(s)&&(l+=this.BAN_WEIGHTS.development),this.blocksCastling(s)&&(l+=this.BAN_WEIGHTS.castlingRights),n=Math.max(n,l)}return n}getBannedMoveImpact(e){const t=e.currentBannedMove;if(!t)return 0;let n=10;return this.blocksCenterControl(t)&&(n+=this.BAN_WEIGHTS.centerControl),this.blocksDevelopment(t)&&(n+=this.BAN_WEIGHTS.development),n}generateOrderedActions(e,t,n,s=!1){const l=e.getLegalActions(),p=[];for(const o of l){if(s&&!this.isForcingAction(e,o))continue;let i=0;n&&this.actionsEqual(o,n)&&(i+=1e6),this.isCapture(e,o)&&(i+=1e5+this.getMVVLVA(e,o)),this.isKillerMove(t,o)&&(i+=9e4),i+=this.getHistoryScore(o),"ban"in o&&new $(e.fen()).play(o).flags?.banCausedCheckmate&&(i+=5e5),p.push({action:o,score:i})}return p.sort((o,i)=>i.score-o.score),p}blocksCenterControl(e){return["e4","e5","d4","d5"].includes(e.to)}blocksDevelopment(e){return["c3","f3","c6","f6","b5","g5","b4","g4"].includes(e.to)||e.from[1]==="1"||e.from[1]==="8"}blocksCastling(e){return[{from:"e1",to:"g1"},{from:"e1",to:"c1"},{from:"e8",to:"g8"},{from:"e8",to:"c8"}].some(n=>n.from===e.from&&n.to===e.to)}isCapture(e,t){if("ban"in t)return!1;const n=new $(e.fen()),s=this.getMaterialBalance(n);n.play(t);const l=this.getMaterialBalance(n);return Math.abs(l-s)>50}isForcingAction(e,t){if(this.isCapture(e,t))return!0;const s=new $(e.fen()).play(t);return s.flags?.check||s.flags?.checkmate||s.flags?.banCausedCheckmate||!1}getMVVLVA(e,t){return 0}actionsEqual(e,t){return"ban"in e&&"ban"in t?e.ban.from===t.ban.from&&e.ban.to===t.ban.to:"move"in e&&"move"in t?e.move.from===t.move.from&&e.move.to===t.move.to&&e.move.promotion===t.move.promotion:!1}isKillerMove(e,t){return(this.killerMoves[e]||[]).some(s=>this.actionsEqual(s,t))}updateKillers(e,t){this.killerMoves[e]||(this.killerMoves[e]=[]);const n=this.killerMoves[e];n.some(s=>this.actionsEqual(s,t))||(n.unshift(t),n.length>2&&n.pop())}getHistoryScore(e){const t=this.getActionKey(e);return this.historyTable[t]||0}updateHistory(e,t){const n=this.getActionKey(e);this.historyTable[n]=(this.historyTable[n]||0)+t*t}getActionKey(e){return"ban"in e?`b:${e.ban.from}${e.ban.to}`:`m:${e.move.from}${e.move.to}${e.move.promotion||""}`}updatePV(e,t){this.pvTable[e]=[t],this.pvTable[e+1]&&this.pvTable[e].push(...this.pvTable[e+1]),this.pvLength[e]=this.pvTable[e].length}getPVString(){return this.pvTable[0]?this.pvTable[0].map(e=>"ban"in e?`${e.ban.from}${e.ban.to}`:`${e.move.from}${e.move.to}${e.move.promotion||""}`).join(" "):""}probeTT(e){const t=e.fen();return this.ttTable.get(t)||null}storeTT(e,t,n,s,l){const p=e.fen();if(this.ttTable.set(p,{hash:BigInt(0),depth:t,score:n,bound:s,move:l,age:this.ttAge,pv:s==="exact"}),this.ttTable.size>this.ttSize){const o=this.ttTable.size-this.ttSize;let i=0;for(const[f,u]of this.ttTable)if(u.age<this.ttAge-2&&(this.ttTable.delete(f),i++,i>=o))break}}calculateTimeForMove(e){const t=this.config.timeControl,n=e.getActivePlayer()==="white",s=n?t.wtime||5e3:t.btime||5e3,l=n?t.winc||0:t.binc||0,p=t.movestogo||40,o=s/p+l*.8,i=Math.floor(e.getPly()/4);let f=1;return i<10?f=.8:i<30?f=1.2:f=1,Math.min(o*f,s*.1)}shouldStopSearch(){return this.stopSearch?!0:Date.now()-this.searchStartTime>=this.searchTimeLimit}getNPS(){const e=(Date.now()-this.searchStartTime)/1e3;return e<=0?0:Math.floor(this.nodes/e)}getHashFull(){return Math.min(1e3,Math.floor(this.ttTable.size*1e3/this.ttSize))}stop(){this.stopSearch=!0}evaluatePosition(e){return this.evaluate(e)}}let ue=null,oe=null,ke=null,me=!1,de=0;self.onmessage=async r=>{const{type:e,payload:t}=r.data;switch(e){case"INIT":ue=new ee({maxDepth:t.depth||6,timeLimit:t.timeLimit||3e3}),oe=new Ue({hash:128,moveTime:t.timeLimit||3e3}),self.postMessage({type:"READY"});break;case"FIND_BEST_MOVE":if(!ue||!oe){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}try{me=!0,de=Date.now();const s=new $(t.fen);self.postMessage({type:"SEARCH_UPDATE",depth:0,nodes:0,evaluation:0,pv:[],time:0});const l=t.depth||6;let p=null,o=0,i=0;for(let f=1;f<=l&&me;f++){const u=oe.search(s,{depth:f,movetime:Math.min(500,t.timeLimit/l)});if(u.pv.length>0){p=u.pv[0];const y=new $(t.fen);y.play(p),o=oe.evaluatePosition(y)*(s.getActivePlayer()==="white"?1:-1),i=u.nodes,self.postMessage({type:"SEARCH_UPDATE",depth:f,nodes:i,evaluation:o,pv:u.pv.slice(0,5),time:Date.now()-de,nps:u.nps})}if(Date.now()-de>t.timeLimit)break}self.postMessage({type:"BEST_MOVE",move:p,evaluation:o,depth:l,nodes:i,pv:p?[p]:[],time:Date.now()-de})}catch(s){console.error("Engine error:",s),self.postMessage({type:"ERROR",error:s instanceof Error?s.message:"Unknown error"})}finally{me=!1}break;case"ANALYZE_POSITION":if(!ue||!oe){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}try{const s=new $(t.fen),l=oe.evaluatePosition(s),o=s.fen().split(" ")[0];let i=0,f=0;const u={p:1,n:3,b:3,r:5,q:9,k:0};for(const S of o){if(S==="/"||S>="1"&&S<="8")continue;const d=S===S.toUpperCase(),_=u[S.toLowerCase()]||0;d?i+=_:f+=_}const y=s.legalMoves().length+s.legalBans().length;ke={material:(i-f)*100,mobility:y*10,kingBanSafety:s.inCheck()?-50:20,centerControl:Math.abs(l)<100?25:0,totalScore:l},self.postMessage({type:"ANALYSIS",analysis:ke})}catch(s){console.error("Analysis error:",s),self.postMessage({type:"ERROR",error:s instanceof Error?s.message:"Unknown error"})}break;case"GET_TT_STATS":if(!ue){self.postMessage({type:"ERROR",error:"Engine not initialized"});return}const n=ue.getStatistics();self.postMessage({type:"TT_STATS",stats:{size:n.transpositionTableSize,hits:0,hitRate:.35}});break;case"STOP":me=!1;break}};
